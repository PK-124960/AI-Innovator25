import ollama
import streamlit as st
import json 
import re
import ast 
import csv
import os
import fitz
from sentence_transformers import SentenceTransformer
import numpy as np

from numpy.linalg import norm
from datetime import datetime
from docx import Document
from docx.shared import Pt
from docx.enum.text import WD_PARAGRAPH_ALIGNMENT

OLLAMA_HOST = 'http://ollama:11434' 
LLM_MODEL = 'scb10x/llama3.1-typhoon2-8b-instruct:latest'

@st.cache_resource
def init_ollama_client():
    try:
        client = ollama.Client(host=OLLAMA_HOST, timeout=300)
        client.list()
        print("‚úÖ Ollama connection successful.")
        return client, True
    except Exception as e:
        print(f"‚ùå Ollama connection failed: {e}")
        return None, False

ollama_client, OLLAMA_AVAILABLE = init_ollama_client()

# Page 1 : Draft Generation

PROMPT_TEMPLATES = {
        "‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏Ç‡πà‡∏≤‡∏ß‡∏£‡πà‡∏ß‡∏° (‡∏ó‡∏ó.)": """
    # ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à
    ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡πÄ‡∏™‡∏°‡∏µ‡∏¢‡∏ô‡πÄ‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏Å‡∏≤‡∏£‡∏£‡πà‡∏≤‡∏á‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£‡∏ó‡∏´‡∏≤‡∏£ ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏†‡∏≤‡∏©‡∏≤‡∏û‡∏π‡∏î‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô "‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°" ‡∏Ç‡∏≠‡∏á "‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏Ç‡πà‡∏≤‡∏ß‡∏£‡πà‡∏ß‡∏° (‡∏ó‡∏ó.)" ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡∏á‡∏≤‡∏ô‡∏™‡∏≤‡∏£‡∏ö‡∏£‡∏£‡∏ì ‡πÅ‡∏•‡∏∞‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏à‡∏ï‡∏ô‡∏≤‡∏£‡∏°‡∏ì‡πå‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏™‡∏±‡πà‡∏á‡∏Å‡∏≤‡∏£

    # ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (Pattern to Follow)
    ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏µ‡∏¢‡∏ô‡πÅ‡∏ö‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏Ñ‡∏£‡πà‡∏á‡∏Ñ‡∏£‡∏±‡∏î: ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á

    ---
    ### ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà 1: ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏¥‡∏ç‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°/‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ ###
    [‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ]: "‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏à‡∏±‡∏î‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ AI ‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 15 ‡∏™.‡∏Ñ. ‡∏ó‡∏µ‡πà‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡πÉ‡∏´‡∏ç‡πà ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡πÉ‡∏´‡∏°‡πà‡πÜ ‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÅ‡∏ú‡∏ô‡∏Å‡∏™‡πà‡∏á‡∏Ñ‡∏ô‡∏°‡∏≤‡πÅ‡∏ú‡∏ô‡∏Å‡∏•‡∏∞ 2 ‡∏Ñ‡∏ô ‡∏ä‡πà‡∏ß‡∏¢‡∏™‡πà‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 10 ‡∏™.‡∏Ñ. ‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏∞ ‡∏ñ‡∏≤‡∏°‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏û‡∏µ‡πà‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÄ‡∏ö‡∏≠‡∏£‡πå 1234"
    [‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á]:
    ‡πë. ‡∏î‡πâ‡∏ß‡∏¢ [‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î] ‡∏°‡∏µ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏à‡∏±‡∏î‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡πÄ‡∏ä‡∏¥‡∏á‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ "‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏¢‡∏∏‡∏Å‡∏ï‡πå‡πÉ‡∏ä‡πâ‡∏õ‡∏±‡∏ç‡∏ç‡∏≤‡∏õ‡∏£‡∏∞‡∏î‡∏¥‡∏©‡∏ê‡πå‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô" ‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡πë‡πï ‡∏™.‡∏Ñ. ‡πñ‡πó ‡∏ì ‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° [‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°]
    ‡πí. ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏î‡∏±‡∏á‡∏Å‡∏•‡πà‡∏≤‡∏ß‡∏°‡∏µ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏õ‡∏±‡∏ç‡∏ç‡∏≤‡∏õ‡∏£‡∏∞‡∏î‡∏¥‡∏©‡∏ê‡πå‡πÅ‡∏•‡∏∞‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ô‡∏≥‡∏°‡∏≤‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ
    ‡πì. ‡∏à‡∏∂‡∏á‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î ‡πÑ‡∏î‡πâ‡πÇ‡∏õ‡∏£‡∏î‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏Ø ‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏° ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ‡πí ‡∏ô‡∏≤‡∏¢ ‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏à‡πâ‡∏á‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏ó‡∏£‡∏≤‡∏ö‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡πë‡πê ‡∏™.‡∏Ñ. ‡πñ‡πó ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏õ
    ‡πî. ‡∏´‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏à‡∏∞‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà [‡∏¢‡∏® ‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏• ‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏á‡∏≤‡∏ô] ‡πÇ‡∏ó‡∏£. [‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏á‡∏≤‡∏ô]
    ---
    ### ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà 2: ‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•/‡∏Ç‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ###
    [‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ]: "‡∏ù‡πà‡∏≤‡∏¢‡πÄ‡∏£‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß ‡∏≠‡∏¢‡∏≤‡∏Å‡∏à‡∏∞‡∏Ç‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å‡πÄ‡∏•‡∏¢ ‡∏ä‡πà‡∏ß‡∏¢‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡πÄ‡∏î‡πà‡∏ô‡πÜ ‡∏°‡∏≤‡πÉ‡∏´‡πâ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 25 ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö ‡∏™‡πà‡∏á‡∏°‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏µ‡πÄ‡∏°‡∏• Plan.div@rtarf.mi.th"
    [‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á]:
    ‡πë. ‡∏î‡πâ‡∏ß‡∏¢ [‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î] ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡πÅ‡∏•‡∏∞‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£
    ‡πí. ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏î‡∏±‡∏á‡∏Å‡∏•‡πà‡∏≤‡∏ß‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå ‡∏à‡∏∂‡∏á‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î
    ‡πì. ‡∏à‡∏∂‡∏á‡∏Ç‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡πà‡∏ß‡∏°‡∏°‡∏∑‡∏≠‡∏°‡∏≤‡∏¢‡∏±‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô ‡πÑ‡∏î‡πâ‡πÇ‡∏õ‡∏£‡∏î‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏´‡∏£‡∏∑‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏à‡∏±‡∏Å‡∏©‡πå‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πà‡∏ß‡∏¢ ‡∏°‡∏≤‡∏¢‡∏±‡∏á [‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î] ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡πí‡πï [‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏õ‡∏µ] ‡πÇ‡∏î‡∏¢‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå‡∏≠‡∏¥‡πÄ‡∏•‡πá‡∏Å‡∏ó‡∏£‡∏≠‡∏ô‡∏¥‡∏Å‡∏™‡πå [‡∏£‡∏∞‡∏ö‡∏∏‡∏≠‡∏µ‡πÄ‡∏°‡∏•]
    ‡πî. ‡∏´‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏à‡∏∞‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà [‡∏¢‡∏® ‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏• ‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏á‡∏≤‡∏ô] ‡πÇ‡∏ó‡∏£. [‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏á‡∏≤‡∏ô]
    ---

    # ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á
    ‡∏à‡∏á‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≤‡∏á‡∏ï‡πâ‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏õ‡∏•‡∏á **[‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ]` ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô `[‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á]` ‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå

    **‡∏Å‡∏é‡πÄ‡∏´‡∏•‡πá‡∏Å:**
    1.  ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ ‡πî ‡∏Ç‡πâ‡∏≠‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
    2.  ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏™‡πà‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢, ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏™‡πà‡πÅ‡∏ó‡πá‡∏Å, ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏™‡πà‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏∑‡πà‡∏ô‡πÉ‡∏î‡∏ô‡∏≠‡∏Å‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏à‡∏≤‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° ‡πî ‡∏Ç‡πâ‡∏≠‡∏ô‡∏±‡πâ‡∏ô‡πÇ‡∏î‡∏¢‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î
    3.  ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡∏™‡∏≥‡∏ô‡∏ß‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£‡∏ó‡∏´‡∏≤‡∏£‡∏ï‡∏≤‡∏° "‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£"
    4.  ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö ‡πÄ‡∏ä‡πà‡∏ô ‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô, ‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°, ‡∏¢‡∏® ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏¢‡∏∂‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (Placeholder) ‡πÄ‡∏ä‡πà‡∏ô `[‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î]`
    5.  ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ [‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á]

    **‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ ‡∏à‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ:**
    """,

        # Prompt for "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°"
    "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°": """
    # ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à
    ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡πÄ‡∏™‡∏°‡∏µ‡∏¢‡∏ô‡πÄ‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏Å‡∏≤‡∏£‡∏£‡πà‡∏≤‡∏á‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£‡∏ó‡∏´‡∏≤‡∏£ ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏†‡∏≤‡∏©‡∏≤‡∏û‡∏π‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô "‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°" ‡∏Ç‡∏≠‡∏á "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°" ‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡πÅ‡∏ö‡∏ö

    # ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
    ‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å‡∏†‡∏≤‡∏©‡∏≤‡∏û‡∏π‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏µ‡∏¢‡∏ô‡πÅ‡∏ö‡∏ö "‡∏ï‡∏£‡∏£‡∏Å‡∏∞" ‡πÅ‡∏•‡∏∞ "‡∏™‡πÑ‡∏ï‡∏•‡πå" ‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ

    ---
    ### ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà 1: ‡∏Å‡∏£‡∏ì‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ "‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" ###
    [‡∏Ñ‡∏≥‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô]: ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
    [‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö]: "‡∏™‡∏™‡∏ó.‡∏ó‡∏£. ‡πÄ‡∏Ç‡∏≤‡∏°‡∏≤‡∏Ç‡∏≠‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Å‡∏£‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ç‡πà‡∏≤‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡πÑ‡∏ã‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 27 ‡∏°.‡∏Ñ. ‡πÅ‡∏ï‡πà‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏•‡∏¢ ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏ï‡∏≥‡∏£‡∏≤‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏Å‡∏±‡∏ô‡∏≠‡∏¢‡∏π‡πà ‡∏Ñ‡∏á‡∏ä‡πà‡∏ß‡∏¢‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏ó‡∏≥‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡πÑ‡∏õ‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πà‡∏≠‡∏¢"

    #### ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ####
    ‡πë. ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà ‡∏™‡∏™‡∏ó.‡∏ó‡∏£. ‡∏Ç‡∏≠‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Å‡∏£‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢‡πÉ‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ ‚Äú‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£‡∏Ç‡πà‡∏≤‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡πÉ‡∏ô‡∏°‡∏¥‡∏ï‡∏¥‡πÑ‡∏ã‡πÄ‡∏ö‡∏≠‡∏£‡πå‚Äù ‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡πí‡πó ‡∏°.‡∏Ñ. ‡πñ‡πò
    ‡πí. ‡∏Ç‡πâ‡∏≠‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤ ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô [‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î] ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏´‡πâ‡∏ß‡∏á‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏ó‡∏≥‡∏ï‡∏≥‡∏£‡∏≤‡πÉ‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏±‡∏á‡∏Å‡∏•‡πà‡∏≤‡∏ß ‡∏à‡∏∂‡∏á‡∏¢‡∏±‡∏á‡∏Ç‡∏≤‡∏î‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå ‡∏à‡∏∂‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Å‡∏£‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡πÑ‡∏î‡πâ ‡∏ó‡∏±‡πâ‡∏á‡∏ô‡∏µ‡πâ ‡πÑ‡∏î‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏Å‡∏±‡∏ö ‡∏™‡∏™‡∏ó.‡∏ó‡∏£. ‡πÉ‡∏ô‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß
    ‡πì. ‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠ ‡πÄ‡∏´‡πá‡∏ô‡∏Ñ‡∏ß‡∏£‡∏°‡∏µ‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡πÉ‡∏´‡πâ ‡∏™‡∏™‡∏ó.‡∏ó‡∏£. ‡∏ó‡∏£‡∏≤‡∏ö
    ‡∏à‡∏∂‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏°‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏õ‡∏£‡∏î‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤ ‡∏´‡∏≤‡∏Å‡πÄ‡∏´‡πá‡∏ô‡∏™‡∏°‡∏Ñ‡∏ß‡∏£‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠ ‡πì
    ---
    ### ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà 2: ‡∏Å‡∏£‡∏ì‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ "‡πÄ‡∏™‡∏ô‡∏≠" ###
    [‡∏Ñ‡∏≥‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô]: ‡πÄ‡∏™‡∏ô‡∏≠
    [‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö]: "‡∏™.‡∏≠.‡∏´‡∏ç‡∏¥‡∏á ‡∏û‡∏£‡∏£‡∏©‡∏ß‡∏•‡∏±‡∏¢ ‡∏≠‡∏¢‡∏≤‡∏Å‡∏•‡∏≤‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏´‡∏≤‡∏£‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ö‡∏±‡∏ï‡∏£‡∏ó‡∏µ‡πà ‡∏ö‡∏Å.‡∏ó‡∏ó. ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà 16 ‡πÄ‡∏°.‡∏¢. 68 ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÄ‡∏£‡∏≤‡∏î‡∏π‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡πá‡πÄ‡∏´‡πá‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏∞ ‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏™‡∏ô‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πà‡∏≠‡∏¢"

    #### ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ####
    ‡πë. ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà ‡∏Å‡∏Å‡∏•.‡∏ô‡∏ã‡∏ö.‡∏ó‡∏´‡∏≤‡∏£ ‡∏Ç‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡πá‡∏ô‡∏ä‡∏≠‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏•‡∏≤‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á ‡∏™.‡∏≠.‡∏´‡∏ç‡∏¥‡∏á ‡∏û‡∏£‡∏£‡∏©‡∏ß‡∏•‡∏±‡∏¢ ‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏°‡πÄ‡∏û‡πá‡∏ä‡∏£‡∏£‡∏±‡∏ï‡∏ô‡πå ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á [‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á] ‡∏ã‡∏∂‡πà‡∏á‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏Ç‡∏≠‡∏•‡∏≤‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏£‡∏à‡∏∏‡πÄ‡∏õ‡πá‡∏ô‡∏ô‡∏≤‡∏¢‡∏ó‡∏´‡∏≤‡∏£‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ö‡∏±‡∏ï‡∏£ ‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î ‡∏Å‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏≤‡∏Å‡∏≤‡∏£‡∏Å‡∏≠‡∏á‡∏ó‡∏±‡∏û‡πÑ‡∏ó‡∏¢ ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà ‡πë‡πñ ‡πÄ‡∏°.‡∏¢. ‡πñ‡πò ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏ô‡πÑ‡∏õ
    ‡πí. [‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î] ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏∞‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏≤‡∏¢‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Å‡∏≤‡∏£ ‡πÑ‡∏î‡πâ‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏´‡πá‡∏ô‡∏ß‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏≠‡∏≠‡∏Å‡∏î‡∏±‡∏á‡∏Å‡∏•‡πà‡∏≤‡∏ß‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏ï‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πà‡∏ß‡∏¢ ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏ß‡∏±‡∏ç‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏à‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡πâ‡∏≤‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏ô‡∏™‡∏≤‡∏¢‡∏≠‡∏≤‡∏ä‡∏µ‡∏û‡∏Ç‡∏≠‡∏á‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏• ‡∏à‡∏∂‡∏á‡πÄ‡∏´‡πá‡∏ô‡∏ä‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏≠‡∏≠‡∏Å‡∏î‡∏±‡∏á‡∏Å‡∏•‡πà‡∏≤‡∏ß
    ‡πì. ‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠ ‡πÄ‡∏´‡πá‡∏ô‡∏Ñ‡∏ß‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ï‡πâ‡∏ô‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î‡∏Ç‡∏≠‡∏á‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•‡∏ó‡∏£‡∏≤‡∏ö ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏õ
    ‡∏à‡∏∂‡∏á‡πÄ‡∏™‡∏ô‡∏≠‡∏°‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ó‡∏£‡∏≤‡∏ö‡πÅ‡∏•‡∏∞‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡πÑ‡∏õ
    ---

    ## üìù ‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (Your Task) ##
    ‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡∏≠‡∏á `#### ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ####` ‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á ‡πÇ‡∏î‡∏¢‡∏¢‡∏∂‡∏î‡∏ñ‡∏∑‡∏≠‡∏Å‡∏é‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏Ñ‡∏£‡πà‡∏á‡∏Ñ‡∏£‡∏±‡∏î:

    1.  **‡∏Å‡∏é‡∏Ñ‡∏≥‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢:** ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö `[‡∏Ñ‡∏≥‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô]` ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏°‡∏≤
        - ‡∏´‡∏≤‡∏Å‡πÄ‡∏õ‡πá‡∏ô **‡πÄ‡∏£‡∏µ‡∏¢‡∏ô**, ‡πÉ‡∏´‡πâ‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢ **"‡∏à‡∏∂‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏°‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏õ‡∏£‡∏î..."**
        - ‡∏´‡∏≤‡∏Å‡πÄ‡∏õ‡πá‡∏ô **‡πÄ‡∏™‡∏ô‡∏≠**, ‡πÉ‡∏´‡πâ‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢ **"‡∏à‡∏∂‡∏á‡πÄ‡∏™‡∏ô‡∏≠‡∏°‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏∏‡∏ì‡∏≤..."**
    2.  **‡∏Å‡∏é‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á:** ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ ‡πì ‡∏Ç‡πâ‡∏≠ ‡∏ï‡∏≤‡∏°‡∏ï‡∏£‡∏£‡∏Å‡∏∞ "‡πÄ‡∏´‡∏ï‡∏∏ -> ‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤ -> ‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠" ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠ ‡πì ‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ "‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠"
    3.  **‡∏Å‡∏é‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤:** ‡∏´‡πâ‡∏≤‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡πÇ‡∏î‡∏¢‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î
    4.  **‡∏Å‡∏é‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î):** ‡∏´‡πâ‡∏≤‡∏°‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏¥‡πà‡∏á‡∏≠‡∏∑‡πà‡∏ô‡πÉ‡∏î‡∏ô‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô **‡∏à‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏î‡πâ‡∏ß‡∏¢ "‡πë." ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ**
    """
}
    
def draft_generation(client, user_prompt: str, doc_type: str, formality_level: str, doc_salutation: str = ""):

    if not OLLAMA_AVAILABLE:
        return "‡∏£‡∏∞‡∏ö‡∏ö AI ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô"

    system_prompt = PROMPT_TEMPLATES.get(doc_type)

    if not system_prompt:
        return f"‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏û‡∏ö Prompt Template ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ '{doc_type}'"
    
    full_user_content = f"""
    [‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ]
    ---
    {user_prompt}
    ---
    ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£: {formality_level}
    """

    try:
        response = client.chat(
            model=LLM_MODEL,
            messages=[
                {'role': 'system', 'content': system_prompt}, 
                {'role': 'user', 'content': full_user_content}  
            ],
            options = {
                'temperature': 0.05,       
                'num_predict': 2048,       
                'top_p': 0.5,              
                'repetition_penalty': 1.15 
            }
        )
        cleaned_response = response['message']['content'].replace("```", "").strip()
        return cleaned_response
    except Exception as e:
        return f"‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ AI: {e}"

    
# Page 2 : Outgoing Letter Creation

def extract_structured_data(client, ocr_text_content: str, document_type: str, system_prompt: str, user_prompt_template: str):
    """Calls LLM to extract structured data from OCR text using the pre-configured client."""
    if not OLLAMA_AVAILABLE or client is None:
        raise ConnectionError("Ollama client is not available for data extraction.")
    
    if not ocr_text_content or ocr_text_content.isspace():
        raise ValueError("No OCR text provided for data extraction.")
    
    user_prompt = user_prompt_template.format(ocr_text=ocr_text_content)
    try:
        response = client.chat(
            model=LLM_MODEL,
            messages=[
                {'role': 'system', 'content': system_prompt},
                {'role': 'user', 'content': user_prompt}
            ],
            format="json",
            options={'temperature': 0.05, 'num_predict': 3500}
        )
        content_str = response['message']['content']
        
        print("="*50)
        print("RAW RESPONSE FROM OLLAMA:")
        print(content_str)
        print("="*50)

        try:
            return json.loads(content_str)
        except json.JSONDecodeError:
            json_match = re.search(r'\{.*\}', content_str, re.DOTALL)
            if json_match:
                return json.loads(json_match.group(0))
            else:
                raise ValueError("LLM did not return a valid JSON object.")

    except Exception as e:
        print(f"Error during Ollama chat for data extraction: {e}")
        raise e

        
CORRECT_UNIT_ABBREVIATIONS = [
    "‡∏Å‡∏ò‡∏Å.‡∏®‡∏ã‡∏ö.‡∏ó‡∏´‡∏≤‡∏£", "‡∏Å‡∏ß‡∏Å.‡∏®‡∏ã‡∏ö.‡∏ó‡∏´‡∏≤‡∏£", "‡∏ú‡∏á‡∏õ.‡∏ô‡∏ã‡∏ö.‡∏ó‡∏´‡∏≤‡∏£", "‡∏ú‡∏Å‡∏á.‡∏ô‡∏ã‡∏ö.‡∏ó‡∏´‡∏≤‡∏£", "‡∏ô‡∏ï‡∏™.‡∏ô‡∏ã‡∏ö.‡∏ó‡∏´‡∏≤‡∏£", "‡∏ô‡∏ò‡∏ô.‡∏ô‡∏ã‡∏ö.‡∏ó‡∏´‡∏≤‡∏£", "‡∏Å‡∏Å‡∏•.‡∏ô‡∏ã‡∏ö.‡∏ó‡∏´‡∏≤‡∏£","‡∏Å‡∏Ç‡∏ã.‡∏ô‡∏ã‡∏ö.‡∏ó‡∏´‡∏≤‡∏£","‡∏Å‡∏¢‡∏Å.‡∏ô‡∏ã‡∏ö.‡∏ó‡∏´‡∏≤‡∏£", 
    "‡∏Å‡∏ï‡∏ã.‡∏ô‡∏ã‡∏ö.‡∏ó‡∏´‡∏≤‡∏£", "‡∏™‡∏õ‡∏Å.‡∏ô‡∏ã‡∏ö.‡∏ó‡∏´‡∏≤‡∏£", "‡∏Å‡∏õ‡∏Å.‡πë ‡∏™‡∏õ‡∏Å.‡∏ô‡∏ã‡∏ö.‡∏ó‡∏´‡∏≤‡∏£", "‡∏Å‡∏õ‡∏Å.‡πí ‡∏™‡∏õ‡∏Å.‡∏ô‡∏ã‡∏ö.‡∏ó‡∏´‡∏≤‡∏£", "‡∏Å‡∏õ‡∏Å.‡πì ‡∏™‡∏õ‡∏Å.‡∏ô‡∏ã‡∏ö.‡∏ó‡∏´‡∏≤‡∏£", "‡∏Å‡∏õ‡∏Å.‡∏®‡∏ã‡∏ö.‡∏ó‡∏´‡∏≤‡∏£", "‡∏®‡∏ã‡∏•.‡∏ô‡∏ã‡∏ö.‡∏ó‡∏´‡∏≤‡∏£",
    "‡∏Å‡∏ß‡∏Å.‡∏®‡∏ã‡∏•.‡∏ô‡∏ã‡∏ö.‡∏ó‡∏´‡∏≤‡∏£", "‡∏£‡∏£.‡∏ã‡∏ö.‡∏ó‡∏´‡∏≤‡∏£ ‡∏®‡∏ã‡∏•.‡∏ô‡∏ã‡∏ö.‡∏ó‡∏´‡∏≤‡∏£", "‡∏Å‡∏®‡∏©.‡∏£‡∏£.‡∏ã‡∏ö.‡∏ó‡∏´‡∏≤‡∏£ ‡∏®‡∏ã‡∏•.‡∏ô‡∏ã‡∏ö.‡∏ó‡∏´‡∏≤‡∏£", "‡∏™‡∏ô.‡∏ö‡∏Å.‡∏ö‡∏Å.‡∏ó‡∏ó.", "‡∏™‡∏•‡∏Å.‡∏ö‡∏Å.‡∏ó‡∏ó.", "‡∏™‡∏à‡∏£.‡∏ó‡∏´‡∏≤‡∏£", "‡∏™‡∏ï‡∏ô.‡∏ó‡∏´‡∏≤‡∏£", "‡∏™‡∏™‡∏Å.‡∏ó‡∏´‡∏≤‡∏£",
    "‡∏™‡∏™‡∏Å.‡∏ö‡∏Å.‡∏ó‡∏ó.", "‡∏™‡∏¢‡∏¢.‡∏ó‡∏´‡∏≤‡∏£", "‡∏•‡∏ä‡∏ó.‡∏£‡∏≠‡∏á", "‡∏®‡∏õ‡∏£.", "‡∏®‡∏ã‡∏ö.‡∏ó‡∏´‡∏≤‡∏£", "‡∏™‡∏ò‡∏ô.‡∏ó‡∏´‡∏≤‡∏£", "‡∏Ç‡∏ß.‡∏ó‡∏´‡∏≤‡∏£", "‡∏¢‡∏Å.‡∏ó‡∏´‡∏≤‡∏£", "‡∏Å‡∏ö.‡∏ó‡∏´‡∏≤‡∏£", "‡∏Å‡∏£.‡∏ó‡∏´‡∏≤‡∏£", "‡∏Å‡∏ô.‡∏ó‡∏´‡∏≤‡∏£", "‡∏™‡∏™.‡∏ó‡∏´‡∏≤‡∏£", "‡∏Å‡∏õ‡∏ó.‡∏®‡∏ó‡∏™.‡∏™‡∏™.‡∏ó‡∏´‡∏≤‡∏£",
    "‡∏Å‡∏ó‡∏Ñ.‡∏®‡∏ó‡∏ó.‡∏™‡∏™.‡∏ó‡∏´‡∏≤‡∏£", "‡∏û‡∏±‡∏ô.‡∏õ‡∏™‡∏≠.‡∏™‡∏™.‡∏ó‡∏´‡∏≤‡∏£", "‡∏£‡πâ‡∏≠‡∏¢.‡∏ö‡∏Å.‡∏û‡∏±‡∏ô.‡∏™.‡∏ö‡∏Å.‡∏ó‡∏ó.‡∏™‡∏™.‡∏ó‡∏´‡∏≤‡∏£", "‡∏£‡πâ‡∏≠‡∏¢.‡∏ö‡∏Å.‡∏û‡∏±‡∏ô.‡∏™.", "‡∏™‡∏õ‡∏ä.‡∏ó‡∏´‡∏≤‡∏£", "‡∏ô‡∏ó‡∏û.", "‡∏®‡∏£‡∏†.", "‡∏®‡∏ï‡∏Å.", "‡∏™‡∏ö.‡∏ó‡∏´‡∏≤‡∏£", "‡∏Å‡∏á.‡∏ó‡∏´‡∏≤‡∏£", "‡∏ú‡∏ó.‡∏ó‡∏´‡∏≤‡∏£",
    "‡∏¢‡∏ö.‡∏ó‡∏´‡∏≤‡∏£", "‡∏™‡∏ô‡∏û.‡∏¢‡∏ö.‡∏ó‡∏´‡∏≤‡∏£", "‡∏ä‡∏î.‡∏ó‡∏´‡∏≤‡∏£", "‡∏ö‡∏Å.‡∏™‡∏õ‡∏ó.", "‡∏ß‡∏õ‡∏≠.‡∏™‡∏õ‡∏ó.", "‡∏ß‡∏™‡∏ó.‡∏™‡∏õ‡∏ó.", "‡∏™‡∏à‡∏ß.‡∏™‡∏õ‡∏ó.", "‡∏®‡∏®‡∏¢.‡∏™‡∏õ‡∏ó.", "‡∏™‡∏®‡∏ó.‡∏™‡∏õ‡∏ó.", "‡∏£‡∏£.‡∏ï‡∏ó.‡∏™‡∏õ‡∏ó.", "‡∏£‡∏£.‡∏ä‡∏ó.‡∏™‡∏õ‡∏ó.",
    "‡∏£‡∏≠‡∏á ‡∏ú‡∏≠.‡∏Å‡∏†‡∏®.‡∏®‡∏®‡∏¢.‡∏™‡∏õ‡∏ó.", "‡∏£‡∏≠‡∏á ‡∏ú‡∏≠.‡∏Å‡∏Å‡∏ß.‡∏ß‡∏™‡∏ó.‡∏™‡∏õ‡∏ó.", "‡∏™‡∏ô.‡∏û‡∏ô.‡∏ß‡∏™‡∏ó.‡∏™‡∏õ‡∏ó.", "‡∏™‡∏ô.‡∏û‡∏ô.‡∏™‡∏õ‡∏ó.", "‡∏™‡∏ô.‡∏£‡∏≠‡∏á ‡∏ú‡∏ö.‡∏™‡∏õ‡∏ó.", "‡∏™‡∏ô.‡πÄ‡∏™‡∏ò.‡∏™‡∏õ‡∏ó.", "‡∏Å‡∏û.‡∏ó‡∏´‡∏≤‡∏£", "‡∏£‡∏≠‡∏á ‡∏à‡∏Å.‡∏Å‡∏û.‡∏ó‡∏´‡∏≤‡∏£",
    "‡∏à‡∏Å.‡∏Å‡∏û.‡∏ó‡∏´‡∏≤‡∏£", "‡∏ö‡∏Å.‡∏ó‡∏ó.", "‡∏ú‡∏ä.‡∏ú‡∏≠.‡∏Å‡∏£‡∏†.‡∏®‡∏ã‡∏ö.‡∏ó‡∏´‡∏≤‡∏£", "‡∏´‡∏Å.‡∏Å‡∏ò‡∏Å.‡∏®‡∏ã‡∏ö.‡∏ó‡∏´‡∏≤‡∏£", "‡∏Å‡∏£‡∏†.‡∏®‡∏ã‡∏ö.‡∏ó‡∏´‡∏≤‡∏£", "‡∏Å‡∏õ‡∏Å.‡∏®‡∏ã‡∏ö.‡∏ó‡∏´‡∏≤‡∏£", "‡∏Å‡∏ß‡∏Å.‡∏®‡∏ã‡∏ö.‡∏ó‡∏´‡∏≤‡∏£", "‡∏ô‡∏Ç‡∏ï.‡∏®‡∏ã‡∏ö.‡∏ó‡∏´‡∏≤‡∏£", "‡∏ú‡∏≠.‡∏®‡∏ã‡∏ö.‡∏ó‡∏´‡∏≤‡∏£",
    "‡∏Å‡∏¢‡∏Å.‡∏®‡∏ã‡∏ö.‡∏ó‡∏´‡∏≤‡∏£", "‡∏®‡∏ã‡∏•.‡∏ô‡∏ã‡∏ö.‡∏ó‡∏´‡∏≤‡∏£", "‡∏ú‡∏ö.‡∏ô‡∏ã‡∏ö.‡∏ó‡∏´‡∏≤‡∏£", "‡∏ú‡∏≠.‡∏®‡∏ã‡∏•.‡∏ô‡∏ã‡∏ö.‡∏ó‡∏´‡∏≤‡∏£", "‡∏ú‡∏≠.‡∏Å‡∏£‡∏†.‡∏®‡∏ã‡∏ö.‡∏ó‡∏´‡∏≤‡∏£", "‡∏ú‡∏≠.‡∏Å‡∏ß‡∏Å.‡∏®‡∏ã‡∏ö.‡∏ó‡∏´‡∏≤‡∏£", "‡∏®‡∏ä‡∏õ.‡∏ó‡∏´‡∏≤‡∏£", "‡∏ú‡∏≠.‡∏Å‡∏ß‡∏Å.‡∏®‡∏ã‡∏ö.‡∏ó‡∏´‡∏≤‡∏£", "‡∏™‡∏™‡∏à.‡∏ó‡∏´‡∏≤‡∏£",
    "‡∏™‡∏ô‡∏¢.‡∏ó‡∏´‡∏≤‡∏£", "‡∏ß‡∏™‡∏™.‡∏™‡∏õ‡∏ó.", "‡∏™‡∏Ñ‡∏ó.‡∏™‡∏õ‡∏ó.", "‡∏Å‡∏°‡∏®.‡∏ö‡∏Å.‡∏™‡∏õ‡∏ó.", "‡∏£‡∏≠‡∏á ‡πÄ‡∏™‡∏ò.‡∏™‡∏õ‡∏ó.", "‡∏ú‡∏ö.‡∏™‡∏õ‡∏ó.", "‡∏Ñ‡∏ó‡∏™.‡∏ö‡∏Å.‡∏ó‡∏´‡∏≤‡∏£", "‡∏ú‡∏≠.‡∏Å‡∏ô‡∏ú.‡∏™‡∏ú‡∏≠.‡∏™‡∏™.‡∏ó‡∏´‡∏≤‡∏£", "‡∏ú‡∏≠.‡∏™‡∏ú‡∏≠.‡∏™‡∏™.‡∏ó‡∏´‡∏≤‡∏£", "‡∏à‡∏Å.‡∏™‡∏™.‡∏ó‡∏´‡∏≤‡∏£",
    "‡∏ú‡∏≠.‡∏Å‡∏®‡∏ä.‡∏™‡∏®‡∏ó.‡∏™‡∏õ‡∏ó.", "‡πÄ‡∏™‡∏ò.‡∏™‡∏õ‡∏ó.", "‡∏Å‡∏ß‡∏Å.‡∏®‡∏ä‡∏•.‡∏ô‡∏ä‡∏ö.‡∏ó‡∏´‡∏≤‡∏£", "‡∏™‡∏™‡∏ó.‡∏ó‡∏£.", "‡∏®‡∏ä‡∏ö.‡∏™‡∏™‡∏ó.‡∏ó‡∏£.", "‡∏à‡∏Å.‡∏™‡∏™‡∏ó.‡∏ó‡∏£.", "‡∏à‡∏Å.‡∏™‡∏ô.‡∏ó‡∏´‡∏≤‡∏£", "‡∏™‡∏ô‡∏û.‡∏Å‡∏û.‡∏ó‡∏´‡∏≤‡∏£","‡∏®‡∏ã‡∏•.‡∏ô‡∏ã‡∏ö.‡∏ó‡∏´‡∏≤‡∏£"
]

# Key: wrong word (frequently)
# Value: correct word
OCR_CORRECTION_MAP = {
    # ‡∏ï‡∏±‡∏ß‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô ‡∏ô‡∏®.‡∏™‡∏£‡∏ó.
    "‡∏ô‡∏®.‡∏™‡∏£‡∏ó.":"‡∏ô‡∏®.‡∏™‡∏ò‡∏ó.",
    "‡∏®‡∏ä‡∏ö":"‡∏®‡∏ã‡∏ö",
    "‡∏Å‡∏ß‡∏ñ.‡∏®‡∏ä‡∏ö.‡∏ó‡∏´‡∏≤‡∏£": "‡∏Å‡∏ß‡∏Å.‡∏®‡∏ã‡∏ö.‡∏ó‡∏´‡∏≤‡∏£",
    "‡∏Å‡∏£‡∏Å.‡∏®‡∏ä‡∏ö.‡∏ó‡∏´‡∏≤‡∏£": "‡∏Å‡∏£‡∏Å.‡∏®‡∏ã‡∏ö.‡∏ó‡∏´‡∏≤‡∏£",
    "‡∏Å‡∏ò‡∏Å.‡∏®‡∏ä‡∏ö.‡∏ó‡∏´‡∏≤‡∏£": "‡∏Å‡∏ò‡∏Å.‡∏®‡∏ã‡∏ö.‡∏ó‡∏´‡∏≤‡∏£",
    "‡∏Å‡∏ß‡∏Å.‡∏®‡∏ä‡∏ö.‡∏ó‡∏´‡∏≤‡∏£": "‡∏Å‡∏ß‡∏Å.‡∏®‡∏ã‡∏ö.‡∏ó‡∏´‡∏≤‡∏£",
    "‡∏Å‡∏´‡∏Ñ.‡∏®‡∏ó‡∏ó.‡∏™‡∏™.‡∏ó‡∏´‡∏≤‡∏£": "‡∏Å‡∏ó‡∏Ñ.‡∏®‡∏ó‡∏ó.‡∏™‡∏™.‡∏ó‡∏´‡∏≤‡∏£",
    "‡∏Å‡∏õ‡∏†.‡∏®‡∏ä‡∏ö.‡∏ó‡∏´‡∏≤‡∏£": "‡∏Å‡∏õ‡∏Å.‡∏®‡∏ã‡∏ö.‡∏ó‡∏´‡∏≤‡∏£", 
    "‡∏Å‡∏Å.‡∏Å‡∏ò‡∏Å.‡∏®‡∏ä‡∏ö.‡∏ó‡∏´‡∏≤‡∏£": "‡∏´‡∏Å.‡∏Å‡∏ò‡∏Å.‡∏®‡∏ã‡∏ö.‡∏ó‡∏´‡∏≤‡∏£",
    "‡∏Å‡∏ß‡∏†.‡∏®‡∏ä‡∏ö.‡∏ó‡∏´‡∏≤‡∏£": "‡∏Å‡∏ß‡∏Å.‡∏®‡∏ã‡∏ö.‡∏ó‡∏´‡∏≤‡∏£",
    "‡∏®‡∏ä.‡∏ó‡∏´‡∏≤‡∏£. ": "‡∏®‡∏ã‡∏ö.‡∏ó‡∏´‡∏≤‡∏£ ",
    "‡∏Ñ‡∏∏‡∏ì‡∏ó.‡πñ‡πó": "‡∏Ñ‡∏Å‡∏ô‡∏ó.‡πñ‡πó",
    "‡∏™‡∏ô.‡∏û‡∏ô.‡∏ß‡∏™‡∏ó.‡∏™‡∏õ‡∏ó.": "‡∏™‡∏ô.‡∏ú‡∏ö.‡∏ß‡∏™‡∏ó.‡∏™‡∏õ‡∏ó.",
    "‡∏™‡∏ô.‡∏û‡∏ö.‡∏™‡∏õ‡∏ó.": "‡∏™‡∏ô.‡∏ú‡∏ö.‡∏™‡∏õ‡∏ó.",
    "‡∏Å‡∏ß‡∏ï.‡∏®‡∏ä‡∏ö.‡∏ó‡∏´‡∏≤‡∏£": "‡∏Å‡∏ß‡∏Å.‡∏®‡∏ã‡∏ö.‡∏ó‡∏´‡∏≤‡∏£",
    "‡∏ô‡∏ä‡∏ï.‡∏®‡∏ä‡∏ö.‡∏ó‡∏´‡∏≤‡∏£": "‡∏ô‡∏Ç‡∏ï.‡∏®‡∏ã‡∏ö.‡∏ó‡∏´‡∏≤‡∏£",
    "‡∏ú‡∏≠.‡∏®‡∏ä‡∏ö.‡∏ó‡∏´‡∏≤‡∏£": "‡∏ú‡∏≠.‡∏®‡∏ã‡∏ö.‡∏ó‡∏´‡∏≤‡∏£",
    "‡∏®‡∏ä‡∏¢.‡∏™‡∏õ‡∏ó. ": "‡∏®‡∏®‡∏¢.‡∏™‡∏õ‡∏ó. ",
    "‡∏£‡∏≠‡∏á ‡∏ú‡∏≠.‡∏Å‡∏û‡∏®.‡∏®‡∏ä‡∏¢.‡∏™‡∏õ‡∏ó.": "‡∏£‡∏≠‡∏á ‡∏ú‡∏≠.‡∏Å‡∏†‡∏®.‡∏®‡∏®‡∏¢.‡∏™‡∏õ‡∏ó.",
    "‡∏™‡∏ö.‡∏ö‡∏Å.‡∏ó‡∏ó. ": "‡∏™‡∏ô.‡∏ö‡∏Å.‡∏ö‡∏Å.‡∏ó‡∏ó. ",
    "‡∏¢‡∏ô.‡∏ó‡∏´‡∏≤‡∏£": "‡∏¢‡∏ö.‡∏ó‡∏´‡∏≤‡∏£",
    "‡∏ö‡∏Å.‡∏ó‡∏´‡∏≤‡∏£": "‡∏ö‡∏Å.‡∏ó‡∏ó.",
    "‡∏™‡∏™‡∏Ñ.‡∏ö‡∏Å.‡∏ó‡∏ó.": "‡∏™‡∏•‡∏Å.‡∏ö‡∏Å.‡∏ó‡∏ó.",
    "‡∏™‡∏™‡∏†.‡∏ó‡∏´‡∏≤‡∏£": "‡∏™‡∏™‡∏Å.‡∏ó‡∏´‡∏≤‡∏£",
    "‡∏ä‡∏ß.‡∏ó‡∏´‡∏≤‡∏£": "‡∏Ç‡∏ß.‡∏ó‡∏´‡∏≤‡∏£",
    "‡∏ô‡∏ó‡∏ü. ": "‡∏ô‡∏ó‡∏û.",
    "‡∏Å‡∏ß‡∏†.‡∏®‡∏ä.‡∏ô.‡∏ó‡∏´‡∏≤‡∏£": "‡∏Å‡∏ß‡∏Å.‡∏®‡∏ã‡∏ö.‡∏ó‡∏´‡∏≤‡∏£",
    "‡∏®‡∏ä.‡∏ö.‡∏ó‡∏´‡∏≤‡∏£": "‡∏®‡∏ã‡∏ö.‡∏ó‡∏´‡∏≤‡∏£",
    "‡∏Å‡∏Å‡∏•.‡∏ô‡∏ä‡∏ä.‡∏ó‡∏´‡∏≤‡∏£": "‡∏Å‡∏Å‡∏•.‡∏ô‡∏ã‡∏ö.‡∏ó‡∏´‡∏≤‡∏£",
    "‡∏ô‡∏ä‡∏ä.‡∏ó‡∏´‡∏≤‡∏£": "‡∏ô‡∏ã‡∏ö.‡∏ó‡∏´‡∏≤‡∏£",
    "‡∏®‡∏ä‡∏•.‡∏ô‡∏ä‡∏ä.‡∏ó‡∏´‡∏≤‡∏£": "‡∏®‡∏ã‡∏•.‡∏ô‡∏ã‡∏ö.‡∏ó‡∏´‡∏≤‡∏£",
    "‡∏®‡∏ä‡∏•.‡∏ô‡∏ä‡∏ö.‡∏ó‡∏´‡∏≤‡∏£": "‡∏®‡∏ã‡∏•.‡∏ô‡∏ã‡∏ö.‡∏ó‡∏´‡∏≤‡∏£",
    "‡∏Å‡∏õ‡∏ä.‡∏®‡∏ä‡∏ö.‡∏™‡∏™‡∏ó.‡∏ó‡∏£. ": "‡∏Å‡∏õ‡∏ã.‡∏®‡∏ã‡∏ö.‡∏™‡∏™‡∏ó.‡∏ó‡∏£.",
    "‡∏ñ‡∏ß‡∏Å.‡∏®‡∏ä‡∏•.‡∏ô‡∏ä‡∏ö.‡∏ó‡∏´‡∏≤‡∏£": "‡∏Å‡∏ß‡∏Å.‡∏®‡∏ã‡∏•.‡∏ô‡∏ã‡∏ö.‡∏ó‡∏´‡∏≤‡∏£",
    "‡∏Å‡∏®‡∏ä.‡∏™‡∏®‡∏ó.‡∏™‡∏õ‡∏ó.": "‡∏Å‡∏®‡∏©.‡∏™‡∏®‡∏ó.‡∏™‡∏õ‡∏ó.",
    "‡πÄ‡∏™‡∏£.‡∏™‡∏õ‡∏ó. ": "‡πÄ‡∏™‡∏ò.‡∏™‡∏õ‡∏ó. ",
    "‡∏£‡∏ò.‡∏ä‡∏ô.‡∏ó‡∏´‡∏≤‡∏£": "‡∏£‡∏£.‡∏ã‡∏ö.‡∏ó‡∏´‡∏≤‡∏£",
    "‡∏™‡∏ô.‡∏ó‡∏´‡∏≤‡∏£": "‡∏™‡∏ö.‡∏ó‡∏´‡∏≤‡∏£",
    "‡∏Å‡∏™‡∏°.‡∏™‡∏ô.‡∏ó‡∏´‡∏≤‡∏£. ": "‡∏Å‡∏™‡∏ö.‡∏™‡∏ö.‡∏ó‡∏´‡∏≤‡∏£. ",
    "‡∏ô‡∏ä‡∏ï.‡∏®‡∏ä.‡∏ó‡∏´‡∏≤‡∏£": "‡∏ô‡∏Ç‡∏ï.‡∏ô‡∏ã‡∏ö.‡∏ó‡∏´‡∏≤‡∏£",
    "‡∏Å‡∏ß‡∏à.‡∏®‡∏ä‡∏ô.‡∏ó‡∏´‡∏≤‡∏£": "‡∏Å‡∏ß‡∏Å.‡∏®‡∏ã‡∏ö.‡∏ó‡∏´‡∏≤‡∏£",
    "‡∏ú‡∏≠.‡∏®‡∏ä.‡∏õ‡∏ó‡∏´‡∏≤‡∏£": "‡∏ú‡∏≠.‡∏®‡∏ã‡∏ö.‡∏ó‡∏´‡∏≤‡∏£",
    "‡∏Å‡∏ô.‡∏ó‡∏´‡∏≤‡∏£": "‡∏Å‡∏ö.‡∏ó‡∏´‡∏≤‡∏£",
    "‡∏®‡∏ï‡∏ñ. ": "‡∏®‡∏ï‡∏Å. ",
    "‡∏™‡∏Ñ‡∏ó.‡∏™‡∏õ‡∏ó.": "‡∏™‡∏®‡∏ó.‡∏™‡∏õ‡∏ó.",
    "‡∏Å‡∏£‡∏†.‡∏®‡∏ä‡∏ö.‡∏ó‡∏´‡∏≤‡∏£": "‡∏Å‡∏ò‡∏Å.‡∏®‡∏ã‡∏ö.‡∏ó‡∏´‡∏≤‡∏£",
    "‡∏£‡∏£.‡∏£‡∏õ‡∏†.‡∏®‡∏ò. ": "‡∏£‡∏£.‡∏£‡∏õ‡∏†.‡∏®‡∏£‡∏†.",
    "‡∏ô‡∏ó‡∏ó.": "‡∏ô‡∏ó‡∏û.",
    "‡∏Å‡∏£‡∏°‡∏ó‡∏´‡∏≤‡∏£": "‡∏Å‡∏£.‡∏ó‡∏´‡∏≤‡∏£",
    "‡∏Ñ‡∏ä‡∏ä.‡∏ó‡∏´‡∏≤‡∏£": "‡∏®‡∏ã‡∏ö.‡∏ó‡∏´‡∏≤‡∏£",
    "‡∏ñ‡∏ô‡∏ô‡∏ú‡∏à‡∏á‡∏û‡∏´‡∏≤‡∏£": "‡∏Å‡∏ô‡∏ú.‡∏Å‡∏£.‡∏ó‡∏´‡∏≤‡∏£",
    "‡∏™‡∏ß‡∏ú.‡∏¢‡∏Å.‡∏ó‡∏´‡∏≤‡∏£": "‡∏™‡∏ß‡∏ù.‡∏¢‡∏Å.‡∏ó‡∏´‡∏≤‡∏£",
    "‡∏Å‡∏´‡∏®.‡∏®‡∏™‡∏†.‡∏¢‡∏Å.‡∏ó‡∏´‡∏≤‡∏£": "‡∏Å‡∏ù‡∏®.‡∏®‡∏™‡∏†.‡∏¢‡∏Å.‡∏ó‡∏´‡∏≤‡∏£",
    "‡∏Å‡∏´‡∏°.‡∏ô‡∏Å.‡∏™‡∏õ‡∏ó.": "‡∏Å‡∏ó‡∏î.‡∏ö‡∏Å.‡∏™‡∏õ‡∏ó.",
    "‡πÄ‡∏•‡∏Ç‡∏≤.‡∏™‡∏õ‡∏ó.": "‡πÄ‡∏™‡∏ò.‡∏™‡∏õ‡∏ó.",
    "‡∏ú‡∏≠.‡∏ö‡∏ó‡∏ß.‡∏™‡∏õ‡∏ó.": "‡∏ú‡∏≠.‡∏ö‡∏ë‡∏ß.‡∏™‡∏õ‡∏ó.",
    "‡∏Å‡∏à‡∏Å.‡∏™‡∏ô‡∏™. ‡∏Å‡∏°.‡∏ó‡∏´‡∏≤‡∏£": "‡∏Å‡∏à‡∏Å.‡∏™‡∏ö‡∏™.‡∏Å‡∏ö.‡∏ó‡∏´‡∏≤‡∏£",
    "‡∏Å‡∏™‡∏°.‡∏™‡∏ô.‡∏ó‡∏´‡∏≤‡∏£": "‡∏Å‡∏™‡∏ö.‡∏™‡∏ö.‡∏ó‡∏´‡∏≤‡∏£",
    "‡∏Å‡∏û‡∏®.‡∏®‡∏™‡∏†.‡∏¢‡∏Å.‡∏ó‡∏´‡∏≤‡∏£": "‡∏Å‡∏ù‡∏®.‡∏®‡∏™‡∏†.‡∏¢‡∏Å.‡∏ó‡∏´‡∏≤‡∏£",
    "‡∏ñ‡∏ô‡∏ô‡∏ú.‡∏Å‡∏£.‡∏ó‡∏´‡∏≤‡∏£": "‡∏Å‡∏ô‡∏ú.‡∏Å‡∏£.‡∏ó‡∏´‡∏≤‡∏£",
    "‡∏®‡∏ä‡∏ö.‡∏ó‡∏≠.": "‡∏®‡∏ã‡∏ö.‡∏ó‡∏≠.",
    "‡∏£‡∏£.‡∏£‡∏õ‡∏†.‡∏®‡∏ò.": "‡∏£‡∏£.‡∏£‡∏õ‡∏†.‡∏®‡∏£‡∏†.",
    "‡∏Å‡∏Ñ‡∏ä.‡∏ö‡∏Å.‡∏ô‡∏ó‡∏û.": "‡∏Å‡∏Å‡∏ä.‡∏ö‡∏Å.‡∏ô‡∏ó‡∏û.",
    "‡∏Å‡∏ö.‡∏™‡∏Ñ‡∏£.‡∏Å‡∏£.‡∏ó‡∏´‡∏≤‡∏£": "‡∏Å‡∏ö‡∏†.‡∏™‡∏Å‡∏£.‡∏Å‡∏£.‡∏ó‡∏´‡∏≤‡∏£",
    "‡∏ô‡∏ä‡∏ö.‡∏ó‡∏´‡∏≤‡∏£":"‡∏ô‡∏ã‡∏ö.‡∏ó‡∏´‡∏≤‡∏£",

    # General words
    "‡∏•‡∏≤‡∏≠‡∏â‡∏Å.": "‡∏•‡∏≤‡∏≠‡∏≠‡∏Å",
#     "‡πÉ‡∏î‡πâ": "‡πÑ‡∏î‡πâ",
    "0":"‡πê","1":"‡πë","2":"‡πí","3":"‡πì","4":"‡πî",
    "5":"‡πï","6":"‡πñ","7":"‡πó","8":"‡πò","9":"‡πô"
}        
        
def post_process_ocr_text(ocr_text: str) -> str:

    if not ocr_text or not isinstance(ocr_text, str):
        return ""

    processed_text = ocr_text

    # --- ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ö‡πà‡∏≠‡∏¢‡πÜ ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ OCR_CORRECTION_MAP ---
    sorted_correction_keys = sorted(OCR_CORRECTION_MAP.keys(), key=len, reverse=True)
    for wrong_word_key in sorted_correction_keys:
        correct_word_value = OCR_CORRECTION_MAP[wrong_word_key]
        processed_text = processed_text.replace(wrong_word_key, correct_word_value)

    # --- ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2: (‡∏ó‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á - ‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô) ---
    # ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ Fuzzy Matching ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢‡∏Å‡∏±‡∏ö Master List ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡πÄ‡∏õ‡πä‡∏∞
    # **‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô:** ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏≠‡∏≤‡∏à‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ä‡πâ‡∏≤‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß (False Positives)


    # if False: # ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô False ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
    #     try:
    #         from thefuzz import process, fuzz
    #
    #         words_in_text = re.findall(r'\b[\w.-]+\b', processed_text, re.UNICODE)
    #         final_words = []
    #         MIN_FUZZY_SCORE = 88
    #
    #         for word in words_in_text:
    #             is_potential_abbreviation = (
    #                 '.' in word and
    #                 any(c.isupper() for c in word) and
    #                 not word.isdigit() and
    #                 len(word) >= 3
    #             )
    #
    #             if is_potential_abbreviation:
    #                 best_match_tuple = process.extractOne(word, CORRECT_UNIT_ABBREVIATIONS, scorer=fuzz.WRatio)
    #                 if best_match_tuple and best_match_tuple[1] >= MIN_FUZZY_SCORE:
    #                     final_words.append(best_match_tuple[0])
    #                 else:
    #                     final_words.append(word)
    #             else:
    #                 final_words.append(word)
    #         processed_text = " ".join(final_words)
    #
    #     except ImportError:
    #         print("Warning: 'thefuzz' library not found. Skipping fuzzy matching for OCR correction.")
    #         pass

    # --- ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 3: ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (General Text Cleanup) ---
    # 3.1 ‡∏•‡∏î‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡∏£‡∏£‡∏Ñ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
    processed_text = re.sub(r'\s+', ' ', processed_text).strip()

    # 3.2 ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡∏£‡∏£‡∏Ñ‡∏ú‡∏¥‡∏î‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏à‡∏∏‡∏î (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
    processed_text = re.sub(r'\s+\.', '.', processed_text)

    # 3.3 ‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡∏£‡∏£‡∏Ñ
    processed_text = processed_text.replace('\n', ' ')

    # 3.4 ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏Ñ‡∏≥‡∏û‡∏π‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡πÄ‡∏û‡∏µ‡πâ‡∏¢‡∏ô‡∏à‡∏≤‡∏Å OCR
    processed_text = processed_text.replace("‚Äú", "\"").replace("‚Äù", "\"")
    processed_text = processed_text.replace("‚Äò", "'").replace("‚Äô", "'")

    return processed_text

# --- FIELD DEFINITIONS ---
FIELDS_MEMORANDUM = {
    "department": "‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£",
    "document_number": "‡∏ó‡∏µ‡πà (‡πÄ‡∏•‡∏Ç‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠)",
    "date": "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà",
    "subject": "‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á",
    "recipient": "‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡πÄ‡∏™‡∏ô‡∏≠",
    "reference": "‡∏≠‡πâ‡∏≤‡∏á‡∏ñ‡∏∂‡∏á",
    "attachments": "‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤‡∏î‡πâ‡∏ß‡∏¢",
    "body_main": "‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏Å",
    "proposer_rank_name": "‡∏¢‡∏® ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏ô‡∏≠",
    "proposer_position": "‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏ô‡∏≠",
    "approver_rank_name": "‡∏¢‡∏® ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥",
    "approver_position": "‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥"
}

FIELDS_JOINT_NEWS_PAPER = {
    "urgency": "‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô",
    "confidentiality": "‡∏ä‡∏±‡πâ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏±‡∏ö",
    "datetime_group": "‡∏´‡∏°‡∏π‡πà-‡∏ß‡∏±‡∏ô-‡πÄ‡∏ß‡∏•‡∏≤",
    "page_info": "‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà",
    "originator_ref": "‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏Ç‡πà‡∏≤‡∏ß",
    "from_department": "‡∏à‡∏≤‡∏Å (‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á)",
    "to_recipient": "‡∏ñ‡∏∂‡∏á (‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥)",
    "info_recipient": "‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö",
    "body_main": "‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏Ç‡πà‡∏≤‡∏ß",
    "qr_email": "QR Code/Email",
    "responsible_unit": "‡∏´‡∏ô‡πà‡∏ß‡∏¢ (‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö)",
    "phone": "‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå",
    # "reporter_signature": "‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Ç‡πà‡∏≤‡∏ß", # ‡∏Å‡∏≤‡∏£‡∏™‡∏Å‡∏±‡∏î‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏≠‡∏≤‡∏à‡∏¢‡∏≤‡∏Å
    "reporter_rank_name_position": "‡∏¢‡∏® ‡∏ä‡∏∑‡πà‡∏≠ ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Ç‡πà‡∏≤‡∏ß",
    # "approver_signature": "‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏ô‡∏≤‡∏¢‡∏ó‡∏´‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ç‡πà‡∏≤‡∏ß", # ‡∏Å‡∏≤‡∏£‡∏™‡∏Å‡∏±‡∏î‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏≠‡∏≤‡∏à‡∏¢‡∏≤‡∏Å
    "approver_rank_name_position": "‡∏¢‡∏® ‡∏ä‡∏∑‡πà‡∏≠ ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ô‡∏≤‡∏¢‡∏ó‡∏´‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ç‡πà‡∏≤‡∏ß"
}

def get_extraction(document_type: str):

    # ‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°" 
    if document_type == "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°":

        fields_to_extract_map = FIELDS_MEMORANDUM
        fields_to_extract_map_with_new = fields_to_extract_map.copy()
        
        fields_to_extract_map_with_new["proposer_title_suffix"] = "‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏ô‡∏≠ (‡πÄ‡∏ä‡πà‡∏ô ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà, ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡πÅ‡∏ó‡∏ô)"
        fields_to_extract_map_with_new["approver_command"] = "‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (‡πÄ‡∏ä‡πà‡∏ô ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥, ‡∏ó‡∏£‡∏≤‡∏ö, ‡πÄ‡∏´‡πá‡∏ô‡∏ä‡∏≠‡∏ö)"
        fields_to_extract_map_with_new["coordinator_info"] = "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏á‡∏≤‡∏ô (‡∏¢‡∏® ‡∏ä‡∏∑‡πà‡∏≠ ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á ‡πÅ‡∏•‡∏∞‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£)"
        fields_to_extract_map_with_new["main_intent"] = "‡πÄ‡∏à‡∏ï‡∏ô‡∏≤‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ (‡∏™‡∏£‡∏∏‡∏õ)"
        fields_to_extract_map_with_new["requested_action_details"] = "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≠‡∏á‡∏Ç‡∏≠ (‡∏™‡∏£‡∏∏‡∏õ)"
        
        field_descriptions_for_prompt = "\n".join([f"- {desc} (‡πÉ‡∏ä‡πâ key: {key})" for key, desc in fields_to_extract_map_with_new.items()])

        json_example_fields = {
            "department": "‡∏™‡∏ö.‡∏ó‡∏´‡∏≤‡∏£ (‡∏Å‡∏™‡∏ö.‡∏™‡∏ö.‡∏ó‡∏´‡∏≤‡∏£ ‡πÇ‡∏ó‡∏£.‡∏ó‡∏´‡∏≤‡∏£ ‡πï‡πó‡πí‡πë‡πò‡πí‡πë)",
            "document_number": "‡∏ó‡∏µ‡πà ‡∏Å‡∏´ ‡πê‡πì‡πë‡πí/‡πí‡πí‡πï‡πô",
            "date": "‡πë‡πô ‡∏Å.‡∏¢. ‡πñ‡πó",
            "subject": "‡∏Ç‡∏≠‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Å‡∏£",
            "recipient": "‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡∏ú‡∏≠.‡∏®‡∏ã‡∏ö.‡∏ó‡∏´‡∏≤‡∏£",
            "reference": None,
            "attachments": [
                "‡πë. ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏ô‡∏≤‡∏¢‡∏ó‡∏´‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ó‡∏ß‡∏ô‡∏≠‡∏≤‡∏ß‡∏∏‡πÇ‡∏™ ‡∏ö‡∏Å.‡∏ó‡∏ó. ‡∏£‡∏∏‡πà‡∏ô‡∏ó‡∏µ‡πà ‡πë‡πí ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì ‡∏û.‡∏®. ‡πí‡πï‡πñ‡πò",
                "‡πí. ‡πÅ‡∏ö‡∏ö‡∏Å‡∏£‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢"
            ],
            "body_main": "‡πë. ‡∏™‡∏ö.‡∏ó‡∏´‡∏≤‡∏£ ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏ô‡∏≤‡∏¢‡∏ó‡∏´‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ó‡∏ß‡∏ô‡∏≠‡∏≤‡∏ß‡∏∏‡πÇ‡∏™ ‡∏ö‡∏Å.‡∏ó‡∏ó. ‡∏£‡∏∏‡πà‡∏ô‡∏ó‡∏µ‡πà ‡πë‡πí ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì ‡∏û.‡∏®. ‡πí‡πï‡πñ‡πò ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡πò ‡∏ï.‡∏Ñ.-‡πí‡πê ‡∏ò.‡∏Ñ. ‡πñ‡πó ‡∏ì ‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡πò‡πê‡πì ‡∏ä‡∏±‡πâ‡∏ô ‡πò ‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ ‡πô ‡∏ö‡∏Å.‡∏ó‡∏ó. ‡∏ã‡∏∂‡πà‡∏á‡πÉ‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏Ø ‡πÑ‡∏î‡πâ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡πÉ‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏ó‡∏≤‡∏á‡πÑ‡∏ã‡πÄ‡∏ö‡∏≠‡∏£‡πå ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤‡∏î‡πâ‡∏ß‡∏¢ ‡πë\n‡πí. ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏Ø ‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠ ‡πë ‡∏™‡∏ö.‡∏ó‡∏´‡∏≤‡∏£ ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏Ç‡∏≠‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Å‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡πÅ‡∏Å‡πà‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å‡∏≠‡∏ö‡∏£‡∏°‡∏Ø ‡πÉ‡∏ô‡∏ß‡∏±‡∏ô ‡πÄ‡∏ß‡∏•‡∏≤ ‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà ‡∏î‡∏±‡∏á‡∏Å‡∏•‡πà‡∏≤‡∏ß ‡πÇ‡∏î‡∏¢‡∏Ç‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏ö‡∏Å‡∏£‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤‡∏î‡πâ‡∏ß‡∏¢ ‡πí ‡∏ñ‡∏∂‡∏á ‡∏™‡∏ö.‡∏ó‡∏´‡∏≤‡∏£ ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡πí‡πê ‡∏Å.‡∏¢. ‡πñ‡πó",
            "proposer_rank_name": "‡∏û‡∏•.‡∏ó. (‡∏à‡∏¥‡∏£‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå ‡∏û‡∏£‡∏£‡∏±‡∏á‡∏™‡∏§‡∏©‡∏é‡πå)",
            "proposer_position": "‡∏à‡∏Å.‡∏™‡∏ö.‡∏ó‡∏´‡∏≤‡∏£",
            "proposer_title_suffix": None,
            "approver_rank_name": None,
            "approver_position": None,
            "approver_command": None,
            "coordinator_info": "‡∏û.‡∏ï. ‡∏≠‡∏≤‡∏ô‡∏ô‡∏ó‡πå ‡∏î‡∏≤‡∏°‡∏≤‡∏û‡∏á‡∏®‡πå ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÅ‡∏ú‡∏ô‡∏Å‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£ ‡∏Å‡∏™‡∏ö.‡∏™‡∏ö.‡∏ó‡∏´‡∏≤‡∏£ ‡πÇ‡∏ó‡∏£.‡∏ó‡∏´‡∏≤‡∏£ ‡πï‡πó‡πí‡πë‡πò‡πí‡πë",
            "main_intent": "‡∏Ç‡∏≠‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Å‡∏£",
            "requested_action_details": "‡∏Ç‡∏≠‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Å‡∏£‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏ó‡∏≤‡∏á‡πÑ‡∏ã‡πÄ‡∏ö‡∏≠‡∏£‡πå ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢‡∏†‡∏≤‡∏¢‡πÉ‡∏ô ‡πí‡πê ‡∏Å.‡∏¢. ‡πñ‡πó"
        }
        
        # System Prompt
        system_prompt_extraction = f"""‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ AI ‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏Å‡∏≤‡∏£‡∏™‡∏Å‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°" ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£‡πÑ‡∏ó‡∏¢ ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏à‡∏≤‡∏Å OCR ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏•‡∏∞‡∏™‡∏Å‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ó‡∏µ‡∏•‡∏∞‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô (Step-by-Step) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏µ‡πà‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô JSON object ‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô

        **‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÅ‡∏•‡∏∞‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏Å‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å!):**

        **‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏™‡∏Å‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß (Header)**
        - `department`, `document_number`, `date`, `subject`, `recipient`: ‡∏™‡∏Å‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠
        - `reference`, `attachments`: ‡∏™‡∏Å‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô "‡∏≠‡πâ‡∏≤‡∏á‡∏ñ‡∏∂‡∏á" ‡πÅ‡∏•‡∏∞ "‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤‡∏î‡πâ‡∏ß‡∏¢" **‡πÉ‡∏´‡πâ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÄ‡∏õ‡πá‡∏ô list ‡∏Ç‡∏≠‡∏á string ‡πÄ‡∏™‡∏°‡∏≠** ‡πÅ‡∏°‡πâ‡∏à‡∏∞‡∏°‡∏µ‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡πá‡∏ï‡∏≤‡∏° ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô `null` ‡∏´‡∏£‡∏∑‡∏≠ list ‡∏ß‡πà‡∏≤‡∏á `[]`

        **‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏™‡∏Å‡∏±‡∏î‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏´‡∏•‡∏±‡∏Å‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏á‡∏≤‡∏ô (Body & Coordinator)**
        - `body_main`: '‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏Å' ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏Ç‡πâ‡∏≠ ‡πë. (‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å) ‡πÑ‡∏õ‡∏à‡∏ô‡∏ñ‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ **‡∏Å‡πà‡∏≠‡∏ô** ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢ (‡πÄ‡∏ä‡πà‡∏ô '‡∏à‡∏∂‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏°‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏õ‡∏£‡∏î‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤') ‡∏´‡∏£‡∏∑‡∏≠ **‡∏Å‡πà‡∏≠‡∏ô** ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏á‡∏≤‡∏ô
        - `coordinator_info`: ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏ "‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏´‡πâ..." ‡∏´‡∏£‡∏∑‡∏≠ "‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î..." ‡πÅ‡∏•‡πâ‡∏ß‡∏™‡∏Å‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏¢‡∏® ‡∏ä‡∏∑‡πà‡∏≠ ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á ‡πÅ‡∏•‡∏∞‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£) ‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏ï‡∏£‡∏¥‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô `null`

        **‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 3: ‡∏™‡∏Å‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏•‡∏á‡∏ô‡∏≤‡∏° (Signatories) ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î**
        - **‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏ô‡∏≠ (Proposer):**
            - `proposer_rank_name`: ‡∏¢‡∏®‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏ß‡∏á‡πÄ‡∏•‡πá‡∏ö‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏ô‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á
            - `proposer_position`: ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏ô‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á
            - `proposer_title_suffix`: ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î "‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡πÅ‡∏ó‡∏ô", "‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£‡πÅ‡∏ó‡∏ô" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà" ‡πÉ‡∏´‡πâ‡∏™‡∏Å‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏±‡πâ‡∏ô‡∏°‡∏≤‡πÉ‡∏™‡πà‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô `null`
        - **‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (Approver):**
            - ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏ô‡∏≠ ‡πÄ‡∏ä‡πà‡∏ô "‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥", "‡∏ó‡∏£‡∏≤‡∏ö", "‡πÄ‡∏´‡πá‡∏ô‡∏ä‡∏≠‡∏ö"
            - `approver_command`: ‡∏™‡∏Å‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á ‡πÄ‡∏ä‡πà‡∏ô "‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠ ‡πî", "‡∏ó‡∏£‡∏≤‡∏ö"
            - `approver_rank_name`: ‡∏¢‡∏®‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏ß‡∏á‡πÄ‡∏•‡πá‡∏ö‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
            - `approver_position`: ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥

        **‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 4: ‡∏™‡∏Å‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ä‡∏¥‡∏á‡∏™‡∏£‡∏∏‡∏õ (Analysis - ‡∏ó‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢)**
        - `main_intent`: ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏≠‡πà‡∏≤‡∏ô `body_main` ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡∏™‡∏£‡∏∏‡∏õ "‡∏à‡∏∏‡∏î‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î" ‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏•‡∏µ‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡πÄ‡∏ä‡πà‡∏ô "‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á", "‡∏Ç‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡πá‡∏ô‡∏ä‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏≠‡∏≠‡∏Å", "‡∏Ç‡∏≠‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Å‡∏£"
        - `requested_action_details`: ‡πÉ‡∏´‡πâ‡∏™‡∏£‡∏∏‡∏õ‡∏ß‡πà‡∏≤‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£ (Action Item) ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÉ‡∏î (Deadline) ‡πÄ‡∏ä‡πà‡∏ô "‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤", "‡∏™‡πà‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 20 ‡∏Å.‡∏¢. 67"

        **‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏Å‡∏±‡∏î (‡πÇ‡∏õ‡∏£‡∏î‡πÉ‡∏ä‡πâ key ‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©):**
        {field_descriptions_for_prompt}

        ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ü‡∏¥‡∏•‡∏î‡πå‡πÉ‡∏î ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô `null`
        ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á JSON output ‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á:
        {json.dumps(json_example_fields, indent=2, ensure_ascii=False)} 
                """

    # ‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó ""‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏Ç‡πà‡∏≤‡∏ß‡∏£‡πà‡∏ß‡∏° (‡∏ó‡∏ó.)""
    elif document_type == "‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏Ç‡πà‡∏≤‡∏ß‡∏£‡πà‡∏ß‡∏° (‡∏ó‡∏ó.)":

        fields_to_extract_map = FIELDS_JOINT_NEWS_PAPER
        fields_to_extract_map_with_new = fields_to_extract_map.copy()
        fields_to_extract_map_with_new["coordinator_info"] = "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏á‡∏≤‡∏ô (‡∏¢‡∏® ‡∏ä‡∏∑‡πà‡∏≠ ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á ‡πÅ‡∏•‡∏∞‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£)"
        fields_to_extract_map_with_new["main_intent"] = "‡πÄ‡∏à‡∏ï‡∏ô‡∏≤‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ç‡πà‡∏≤‡∏ß"
        fields_to_extract_map_with_new["requested_action_details"] = "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥"

        field_descriptions_for_prompt = "\n".join([f"- {desc} (‡πÉ‡∏ä‡πâ key: {key})" for key, desc in fields_to_extract_map_with_new.items()])

        json_example_fields = {
            "urgency": "‡∏î‡πà‡∏ß‡∏ô‡∏°‡∏≤‡∏Å",
            "confidentiality": None,
            "datetime_group": "‡πí‡πñ‡πê‡πò‡πê‡πê ‡∏Å.‡∏Ñ. ‡πñ‡πó",
            "page_info": "‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà ‡πë ‡∏Ç‡∏≠‡∏á ‡πë ‡∏´‡∏ô‡πâ‡∏≤",
            "originator_ref": "‡∏ó‡∏µ‡πà ‡∏Å‡∏´ ‡πê‡πì‡πê‡πí/‡πî‡πí‡πó‡πì",
            "from_department": "‡∏Å‡∏û.‡∏ó‡∏´‡∏≤‡∏£",
            "to_recipient": "‡∏™‡∏ô.‡∏ö‡∏Å.‡∏ö‡∏Å.‡∏ó‡∏ó. ‡∏™‡∏•‡∏Å.‡∏ö‡∏Å.‡∏ó‡∏ó. ‡∏™‡∏à‡∏£.‡∏ó‡∏´‡∏≤‡∏£ ‡∏™‡∏ï‡∏ô.‡∏ó‡∏´‡∏≤‡∏£ ‡∏™‡∏ò‡∏ô.‡∏ó‡∏´‡∏≤‡∏£ ‡∏™‡∏™‡∏Å.‡∏ó‡∏´‡∏≤‡∏£ ‡∏™‡∏¢‡∏¢.‡∏ó‡∏´‡∏≤‡∏£ ‡∏®‡∏õ‡∏£. ‡∏®‡∏ã‡∏ö.‡∏ó‡∏´‡∏≤‡∏£ ‡∏Ç‡∏ß.‡∏ó‡∏´‡∏≤‡∏£ ‡∏¢‡∏Å.‡∏ó‡∏´‡∏≤‡∏£ ‡∏Å‡∏ö.‡∏ó‡∏´‡∏≤‡∏£ ‡∏Å‡∏£.‡∏ó‡∏´‡∏≤‡∏£ ‡∏™‡∏™.‡∏ó‡∏´‡∏≤‡∏£ ‡∏™‡∏õ‡∏ä.‡∏ó‡∏´‡∏≤‡∏£ ‡∏ô‡∏ó‡∏û. ‡∏®‡∏£‡∏†. ‡∏®‡∏ï‡∏Å. ‡∏™‡∏ö.‡∏ó‡∏´‡∏≤‡∏£ ‡∏Å‡∏á.‡∏ó‡∏´‡∏≤‡∏£ ‡∏ú‡∏ó.‡∏ó‡∏´‡∏≤‡∏£ ‡∏¢‡∏ö.‡∏ó‡∏´‡∏≤‡∏£ ‡∏ä‡∏î.‡∏ó‡∏´‡∏≤‡∏£ ‡πÅ‡∏•‡∏∞ ‡∏™‡∏õ‡∏ó.",
            "info_recipient": "‡∏™‡∏ô‡∏û.‡∏¢‡∏ö.‡∏ó‡∏´‡∏≤‡∏£ ‡∏ß‡∏õ‡∏≠.‡∏™‡∏õ‡∏ó. ‡∏ß‡∏™‡∏ó.‡∏™‡∏õ‡∏ó. ‡∏®‡∏®‡∏¢.‡∏™‡∏õ‡∏ó. ‡∏™‡∏à‡∏ß.‡∏™‡∏õ‡∏ó. ‡∏£‡∏£.‡∏ï‡∏ó.‡∏™‡∏õ‡∏ó. ‡∏£‡∏£.‡∏ä‡∏ó.‡∏™‡∏õ‡∏ó. ‡πÅ‡∏•‡∏∞ ‡∏™‡∏®‡∏ó.‡∏™‡∏õ‡∏ó.",
            "body_main": "‡πë. ‡∏Å‡∏û.‡∏ó‡∏´‡∏≤‡∏£ ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡πÄ‡∏ä‡∏¥‡∏á‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£ ‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Ç‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£‡πÉ‡∏ô ‡∏ö‡∏Å.‡∏ó‡∏ó. ... ‡πí. ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠ ‡πë ‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏ú‡∏π‡πâ‡πÅ‡∏ó‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡πÄ‡∏ä‡∏¥‡∏á‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ø ‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ ... (‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏ô‡∏ñ‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢)",
            "qr_email": "Kanyarat.y@rtarf.mi.th ‡∏´‡∏£‡∏∑‡∏≠‡πÇ‡∏ó‡∏£‡∏™‡∏≤‡∏£ ‡πê ‡πí‡πï‡πó‡πï ‡πñ‡πê‡πë‡πï",
            "responsible_unit": "‡∏Å‡∏ô‡∏ú.‡∏™‡∏ô‡∏ú‡∏û.‡∏Å‡∏û.‡∏ó‡∏´‡∏≤‡∏£",
            "phone": "‡πê ‡πí‡πï‡πó‡πï ‡πñ‡πê‡πë‡πï",
            "reporter_rank_name_position": "‡∏ô.‡∏≠. (‡∏ê‡∏¥‡∏ï‡∏¥‡∏û‡∏±‡∏ô‡∏ò‡πå ‡∏ö‡∏∏‡∏ï‡∏£‡∏î‡∏µ‡∏™‡∏∏‡∏ß‡∏£‡∏£‡∏ì) ‡∏ú‡∏≠.‡∏Å‡∏ô‡∏ú.‡∏™‡∏ô‡∏ú‡∏û.‡∏Å‡∏û.‡∏ó‡∏´‡∏≤‡∏£",
            "approver_rank_name_position": "‡∏û‡∏•.‡∏ï. (‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå ‡∏£‡∏á‡∏®‡πå‡∏à‡∏≥‡πÄ‡∏£‡∏¥‡∏ç) ‡∏£‡∏≠‡∏á ‡∏à‡∏Å.‡∏Å‡∏û.‡∏ó‡∏´‡∏≤‡∏£ ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡πÅ‡∏ó‡∏ô ‡∏à‡∏Å.‡∏Å‡∏û.‡∏ó‡∏´‡∏≤‡∏£",
            "coordinator_info": "‡∏£.‡∏ó. ‡∏†‡∏π‡∏†‡∏ß‡∏∞ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏ú‡∏• ‡∏£.‡∏ô. ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÅ‡∏ú‡∏ô‡∏Å‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡πÅ‡∏ú‡∏ô ‡∏Å‡∏ô‡∏ú.‡∏™‡∏ô‡∏ú‡∏û.‡∏Å‡∏û.‡∏ó‡∏´‡∏≤‡∏£ ‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà ‡πê‡πò ‡πô‡πë‡πñ‡πî ‡πí‡πê‡πí‡πï ‡πÇ‡∏ó‡∏£.‡∏ó‡∏´‡∏≤‡∏£ ‡πï‡πó‡πí‡πë‡πë‡πë‡πò",
            "main_intent": "‡πÄ‡∏ä‡∏¥‡∏ç‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡πÄ‡∏ä‡∏¥‡∏á‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ø ‡πÅ‡∏•‡∏∞‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÅ‡∏ó‡∏ô",
            "requested_action_details": "‡∏à‡∏±‡∏î‡∏ú‡∏π‡πâ‡πÅ‡∏ó‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° (‡∏´‡∏ô.‡∏™‡∏≤‡∏¢‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏ô‡∏≤‡∏¢‡∏ó‡∏´‡∏≤‡∏£‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏• ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏≤‡∏¢‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÅ‡∏ú‡∏ô‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô) ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏®‡∏∏‡∏Å‡∏£‡πå‡∏ó‡∏µ‡πà ‡πë‡πô ‡∏Å.‡∏Ñ. ‡πñ‡πó"
        }

        # System Prompt
        system_prompt_extraction = f"""‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ AI ‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏Å‡∏≤‡∏£‡∏™‡∏Å‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ "‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏Ç‡πà‡∏≤‡∏ß‡∏£‡πà‡∏ß‡∏° (‡∏ó‡∏ó.)" ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£‡πÑ‡∏ó‡∏¢ ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏à‡∏≤‡∏Å OCR ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏•‡∏∞‡∏™‡∏Å‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ó‡∏µ‡∏•‡∏∞‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô (Step-by-Step) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏µ‡πà‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô JSON object ‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô

        **‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÅ‡∏•‡∏∞‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏Å‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å!):**

        **‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏™‡∏Å‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß (Header)**
        - `urgency`: ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ç‡πà‡∏≤‡∏ß‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á '‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô' ‡πÄ‡∏ä‡πà‡∏ô '‡∏î‡πà‡∏ß‡∏ô‡∏°‡∏≤‡∏Å', '‡∏î‡πà‡∏ß‡∏ô', ‡∏´‡∏£‡∏∑‡∏≠ `null` ‡∏ñ‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á
        - `datetime_group`: '‡∏´‡∏°‡∏π‡πà - ‡∏ß‡∏±‡∏ô - ‡πÄ‡∏ß‡∏•‡∏≤' ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
        - `originator_ref`: '‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏Ç‡πà‡∏≤‡∏ß' ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ï‡πâ‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á
        - `from_department`: '‡∏à‡∏≤‡∏Å' ‡∏Ñ‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏Ç‡πà‡∏≤‡∏ß‡∏ô‡∏µ‡πâ

        **‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏™‡∏Å‡∏±‡∏î‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö (Recipients)**
        - `to_recipient`: '‡∏ñ‡∏∂‡∏á (‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥)' ‡πÉ‡∏´‡πâ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏†‡∏≤‡∏¢‡πÉ‡∏ï‡πâ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ô‡∏µ‡πâ ‡πÅ‡∏°‡πâ‡∏à‡∏∞‡∏≠‡∏¢‡∏π‡πà‡∏Ñ‡∏ô‡∏•‡∏∞‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏Å‡πá‡∏ï‡∏≤‡∏° ‡πÉ‡∏´‡πâ‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏ï‡∏£‡∏¥‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡∏£‡∏£‡∏Ñ
        - `info_recipient`: '‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö' ‡πÉ‡∏´‡πâ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏†‡∏≤‡∏¢‡πÉ‡∏ï‡πâ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ô‡∏µ‡πâ ‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏ï‡∏£‡∏¥‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÄ‡∏ä‡πà‡∏ô‡∏Å‡∏±‡∏ô

        **‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 3: ‡∏™‡∏Å‡∏±‡∏î‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏á‡∏≤‡∏ô (Body & Coordinator)**
        - `body_main`: '‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏Ç‡πà‡∏≤‡∏ß' **‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î** ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏Ç‡πâ‡∏≠ ‡πë. ‡∏à‡∏ô‡∏ñ‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ **‡∏Å‡πà‡∏≠‡∏ô** ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏£‡∏∞‡∏ö‡∏∏‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏á‡∏≤‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏•‡∏á‡∏ô‡∏≤‡∏°
        - `coordinator_info`: ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏ "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô..." ‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢‡∏Å‡∏±‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏™‡∏Å‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏¢‡∏® ‡∏ä‡∏∑‡πà‡∏≠ ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á ‡πÅ‡∏•‡∏∞‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£) ‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏ï‡∏£‡∏¥‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô `null`

        **‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 4: ‡∏™‡∏Å‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ó‡πâ‡∏≤‡∏¢ (Footer & Signatories)**
        - `qr_email` / `phone` / `responsible_unit`: ‡∏™‡∏Å‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏ó‡πâ‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏≠‡∏á
        - `reporter_rank_name_position`: ‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á "‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Ç‡πà‡∏≤‡∏ß" ‡πÉ‡∏´‡πâ‡∏™‡∏Å‡∏±‡∏î ‡∏¢‡∏®, ‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏ß‡∏á‡πÄ‡∏•‡πá‡∏ö, ‡πÅ‡∏•‡∏∞‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏ï‡∏£‡∏¥‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
        - `approver_rank_name_position`: ‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á "‡∏ô‡∏≤‡∏¢‡∏ó‡∏´‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ç‡πà‡∏≤‡∏ß" ‡πÉ‡∏´‡πâ‡∏™‡∏Å‡∏±‡∏î ‡∏¢‡∏®, ‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏ß‡∏á‡πÄ‡∏•‡πá‡∏ö, ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á, ‡πÅ‡∏•‡∏∞‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î "‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡πÅ‡∏ó‡∏ô/‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏ó‡∏ô" (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏ï‡∏£‡∏¥‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß

        **‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 5: ‡∏™‡∏Å‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ä‡∏¥‡∏á‡∏™‡∏£‡∏∏‡∏õ (Analysis - ‡∏ó‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢)**
        - `main_intent`: "‡πÄ‡∏à‡∏ï‡∏ô‡∏≤‡∏´‡∏•‡∏±‡∏Å" ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏≠‡πà‡∏≤‡∏ô `body_main` ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡∏™‡∏£‡∏∏‡∏õ "‡∏à‡∏∏‡∏î‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î" ‡∏Ç‡∏≠‡∏á‡∏Ç‡πà‡∏≤‡∏ß‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏•‡∏µ‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡πÄ‡∏ä‡πà‡∏ô "‡πÄ‡∏ä‡∏¥‡∏ç‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°", "‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•", "‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£"
        - `requested_action_details`: "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≠‡∏á‡∏Ç‡∏≠" ‡πÉ‡∏´‡πâ‡∏™‡∏£‡∏∏‡∏õ‡∏ß‡πà‡∏≤‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£ (Action Item) ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÉ‡∏î (Deadline) ‡πÄ‡∏ä‡πà‡∏ô "‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÅ‡∏ó‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏†‡∏≤‡∏¢‡πÉ‡∏ô ‡πë‡πô ‡∏Å.‡∏Ñ. ‡πñ‡πó"

        **‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏Å‡∏±‡∏î (‡πÇ‡∏õ‡∏£‡∏î‡πÉ‡∏ä‡πâ key ‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©):**
        {field_descriptions_for_prompt}

        ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ü‡∏¥‡∏•‡∏î‡πå‡πÉ‡∏î ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô `null` ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏Ñ‡∏£‡πà‡∏á‡∏Ñ‡∏£‡∏±‡∏î
        ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á JSON output ‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á:
        {json.dumps(json_example_fields, indent=2, ensure_ascii=False)}
                """

    else:
        raise ValueError(f"Document type '{document_type}' is not supported for extraction.")

    # --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 3: ‡∏™‡∏£‡πâ‡∏≤‡∏á User Prompt ---
    user_prompt_template = f"""
    ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡∏Å‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ '{document_type}' ‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ:
    --- OCR TEXT START ---
    {{ocr_text}}
    --- OCR TEXT END ---
    ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô JSON object ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÉ‡∏ô system prompt ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
    """
    return system_prompt_extraction, user_prompt_template, list(fields_to_extract_map_with_new.keys())
    

def create_docx_from_text(text_content: str, font_name='TH SarabunPSK', font_size=16) -> bytes:

    document = Document()

    # ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
    style = document.styles['Normal']
    font = style.font
    font.name = font_name
    font.size = Pt(font_size)

    for line in text_content.split('\n'):
        p = document.add_paragraph(line.strip())
        
        run = p.runs[0] if p.runs else p.add_run('')
        run.font.name = font_name
        run.font.size = Pt(font_size)

        p.alignment = WD_PARAGRAPH_ALIGNMENT.JUSTIFY

    from io import BytesIO
    file_stream = BytesIO()
    document.save(file_stream)
    file_stream.seek(0)
    
    return file_stream.getvalue()


def log_feedback_to_csv(log_entry: dict, file_path="feedback/feedback_log.csv"):
    try:
        log_dir = os.path.dirname(file_path)
        if not os.path.exists(log_dir):
            os.makedirs(log_dir)
            print(f"Created directory: {log_dir}")

        fieldnames = [
            "timestamp", "document_type", "document_subject",
            "original_text", "edited_text"
        ]
        file_exists = os.path.isfile(file_path)
        
        with open(file_path, 'a', newline='', encoding='utf-8') as csvfile:
            writer = csv.DictWriter(csvfile, fieldnames=fieldnames)

            if not file_exists:
                writer.writeheader()
            
            writer.writerow(log_entry)
        
        print(f"Successfully logged feedback to {file_path}")

    except Exception as e:
        print(f"Error logging feedback to CSV: {e}")


def replySec1_generation(client, extracted_info: dict, ocr_text_content: str, num_options: int = 3) -> list:
    if not client:
        print("ERROR [replySec1_generation]: Ollama client is not available.")
        return []
    if not ocr_text_content and not extracted_info:
        print("ERROR [replySec1_generation]: No content or extracted info provided.")
        return []

    # --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1: ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô ---
    sender_department = extracted_info.get("department") or extracted_info.get("from_department") or "[‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£‡∏ï‡πâ‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á]"
    doc_number = extracted_info.get("document_number") or "[‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ï‡πâ‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á]"
    doc_date = extracted_info.get("date") or "[‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ï‡πâ‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á]"
    doc_subject = extracted_info.get("subject") or "[‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏£‡∏±‡∏ö]"
    main_intent = extracted_info.get("main_intent") or "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏à‡∏ï‡∏ô‡∏≤‡∏´‡∏•‡∏±‡∏Å‡πÑ‡∏î‡πâ"
    requested_details = extracted_info.get("requested_action_details") or "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≠‡∏á‡∏Ç‡∏≠"

    # --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2: System Prompt ---
    system_prompt = f"""‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ "‡∏™‡∏∏‡∏î‡∏¢‡∏≠‡∏î‡πÄ‡∏™‡∏°‡∏µ‡∏¢‡∏ô‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞" ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏•‡∏∞‡∏¢‡∏Å‡∏£‡πà‡∏≤‡∏á "‡∏Ç‡πâ‡∏≠ ‡πë" ‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥ ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå "‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ï‡πâ‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á" ‡πÅ‡∏•‡∏∞ "‡πÄ‡∏à‡∏ï‡∏ô‡∏≤‡∏´‡∏•‡∏±‡∏Å" ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö ‡πÅ‡∏•‡πâ‡∏ß‡∏¢‡∏Å‡∏£‡πà‡∏≤‡∏á "‡∏Ç‡πâ‡∏≠ ‡πë" ‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ô‡∏±‡πâ‡∏ô‡πÜ

        **<‡∏Å‡∏£‡∏ì‡∏µ‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡πà‡∏≤‡∏á (Case Studies & Drafting Patterns)>**
        ‡∏à‡∏á‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏Å‡∏£‡∏ì‡∏µ‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏µ‡∏¢‡∏ô‡πÅ‡∏ö‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡πà‡∏≤‡∏á‡πÉ‡∏´‡πâ‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î

        ---
        **‡∏Å‡∏£‡∏ì‡∏µ‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏µ‡πà 1: ‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠ (Approval & Forwarding)**
        *   **‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå:** ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å (‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏ö.‡∏ó‡∏´‡∏≤‡∏£) ‡∏Ç‡∏≠‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Å‡∏£ ‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏≤‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏´‡πá‡∏ô‡∏Ñ‡∏ß‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
        *   **‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡πà‡∏≤‡∏á:** ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ï‡πâ‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á ‡πÅ‡∏•‡∏∞‡∏™‡∏£‡∏∏‡∏õ‡πÉ‡∏à‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô
        *   **‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ä‡∏±‡πâ‡∏ô‡∏Ñ‡∏£‡∏π:** "‡πë. ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà ‡∏™‡∏ö.‡∏ó‡∏´‡∏≤‡∏£ ‡∏Ç‡∏≠‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Å‡∏£‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢‡πÉ‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤ ‚Äú‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏ó‡∏≤‡∏á‡πÑ‡∏ã‡πÄ‡∏ö‡∏≠‡∏£‡πå‚Äù ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å‡∏≠‡∏ö‡∏£‡∏°‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏ô‡∏≤‡∏¢‡∏ó‡∏´‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ó‡∏ß‡∏ô‡∏≠‡∏≤‡∏ß‡∏∏‡πÇ‡∏™ ‡∏ö‡∏Å.‡∏ó‡∏ó. ‡∏£‡∏∏‡πà‡∏ô‡∏ó‡∏µ‡πà ‡πë‡πí ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏±‡πâ‡∏ô"

        ---
        **‡∏Å‡∏£‡∏ì‡∏µ‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏µ‡πà 2: ‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡πá‡∏ô‡∏ä‡∏≠‡∏ö‡∏†‡∏≤‡∏¢‡πÉ‡∏ô (Internal Endorsement)**
        *   **‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå:** ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏¢‡πà‡∏≠‡∏¢‡∏†‡∏≤‡∏¢‡πÉ‡∏ô (‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏ò‡∏Å.‡∏®‡∏ã‡∏ö.‡∏ó‡∏´‡∏≤‡∏£) ‡∏™‡πà‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏≤‡∏Ç‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡πá‡∏ô‡∏ä‡∏≠‡∏ö (‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏≠‡∏≠‡∏Å‡∏Ç‡∏≠‡∏á‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•) ‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏≤‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏∞‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏≤‡∏¢‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡πÅ‡∏•‡πâ‡∏ß "‡πÄ‡∏´‡πá‡∏ô‡∏ä‡∏≠‡∏ö"
        *   **‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡πà‡∏≤‡∏á:** ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏¢‡πà‡∏≠‡∏¢ ‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡∏≠‡∏á‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡πÅ‡∏•‡∏∞‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡πá‡∏ô‡∏ä‡∏≠‡∏ö
        *   **‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ä‡∏±‡πâ‡∏ô‡∏Ñ‡∏£‡∏π:** "‡πë. ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà ‡∏Å‡∏ò‡∏Å.‡∏®‡∏ã‡∏ö.‡∏ó‡∏´‡∏≤‡∏£ ‡∏Ç‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡πá‡∏ô‡∏ä‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á ‡∏à.‡∏™.‡∏≠. ‡∏ö‡∏∏‡∏£‡πÄ‡∏ß‡∏ó‡∏¢‡πå ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏®‡∏£‡∏µ‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå ‡∏ã‡∏∂‡πà‡∏á‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏Ç‡∏≠‡∏•‡∏≤‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏õ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡πÄ‡∏≠‡∏Å‡∏ä‡∏ô ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà ‡πë ‡∏Å.‡∏Ñ. ‡πñ‡πó ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏ô‡πÑ‡∏õ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏≠‡πâ‡∏≤‡∏á‡∏ñ‡∏∂‡∏á‡∏ô‡∏±‡πâ‡∏ô"

        ---
        **‡∏Å‡∏£‡∏ì‡∏µ‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏µ‡πà 3: ‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô (Declining Support)**
        *   **‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå:** ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å (‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏™‡∏ó.‡∏ó‡∏£.) ‡∏Ç‡∏≠‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Å‡∏£ ‡πÅ‡∏ï‡πà‡πÄ‡∏£‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏±‡πâ‡∏ô
        *   **‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡πà‡∏≤‡∏á:** ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ï‡πâ‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á ‡πÅ‡∏•‡∏∞‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö
        *   **‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ä‡∏±‡πâ‡∏ô‡∏Ñ‡∏£‡∏π:** "‡πë. ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà ‡∏™‡∏™‡∏ó.‡∏ó‡∏£. ‡∏Ç‡∏≠‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Å‡∏£‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢‡πÉ‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ ‚Äú‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£‡∏Ç‡πà‡∏≤‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡πÉ‡∏ô‡∏°‡∏¥‡∏ï‡∏¥‡πÑ‡∏ã‡πÄ‡∏ö‡∏≠‡∏£‡πå‚Äù ‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡πí‡πó ‡∏°.‡∏Ñ. ‡πñ‡πò ‡∏ô‡∏±‡πâ‡∏ô"

        ---
        **<‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (Correct Output Format Example)>**
        ```json
        {{
          "style_1": "‡πë. ‡∏î‡πâ‡∏ß‡∏¢ ‡∏Å‡∏ò‡∏Å.‡∏®‡∏ã‡∏ö.‡∏ó‡∏´‡∏≤‡∏£ ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏Ç‡∏≠‡πÅ‡∏ï‡πà‡∏á‡∏ï‡∏±‡πâ‡∏á ‡∏•‡∏ä‡∏ó.‡∏£‡∏≠‡∏á ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≤‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ‡πñ ‡∏ô‡∏≤‡∏¢ ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÑ‡∏î‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å‡∏≠‡∏ö‡∏£‡∏°‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏ï‡∏≤‡∏°‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏™‡∏≤‡∏¢‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏ó‡∏≤‡∏á‡πÑ‡∏ã‡πÄ‡∏ö‡∏≠‡∏£‡πå ‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤‡∏î‡πâ‡∏ß‡∏¢ ‡πë ‡πÅ‡∏•‡∏∞ ‡πí",
          "style_2": "‡πë. ‡∏ï‡∏≤‡∏°‡∏≠‡πâ‡∏≤‡∏á‡∏ñ‡∏∂‡∏á ‡∏ú‡∏ö.‡∏ó‡∏™‡∏™. ‡πÑ‡∏î‡πâ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏ï‡πà‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡∏ì‡∏∞‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•‡∏î‡πâ‡∏ß‡∏¢‡∏™‡∏≤‡∏¢‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏Ç‡∏´‡∏°‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç‡∏Å‡∏≤‡∏£‡∏ó‡∏´‡∏≤‡∏£‡∏Ç‡∏≠‡∏á ‡∏ö‡∏Å.‡∏ó‡∏ó. ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤ ‡πÉ‡∏ô‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏•‡∏î‡πâ‡∏ß‡∏¢‡∏™‡∏≤‡∏¢‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Å‡∏≤‡∏£ ‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏Ç‡∏´‡∏°‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç‡∏Å‡∏≤‡∏£‡∏ó‡∏´‡∏≤‡∏£‡∏Ç‡∏≠‡∏á ‡∏ö‡∏Å.‡∏ó‡∏ó. ‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û",
          "style_3": "‡πë. ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà ‡∏ß‡∏™‡∏ó.‡∏™‡∏õ‡∏ó. ‡πÑ‡∏î‡πâ‡∏Ç‡∏≠‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏à‡∏±‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏Ø ‡∏£‡∏∏‡πà‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏≠‡πâ‡∏≤‡∏á‡∏ñ‡∏∂‡∏á‡∏ô‡∏±‡πâ‡∏ô"
        }}

        **<‡∏Å‡∏é‡πÅ‡∏•‡∏∞‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå (Rules & Output Format)>**
        1.  ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô JSON Object ‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡πÅ‡∏•‡∏∞‡∏°‡∏µ key style_1, style_2, style_3 ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
        2.  ‡∏´‡πâ‡∏≤‡∏°‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏∑‡πà‡∏ô‡πÉ‡∏î‡∏ô‡∏≠‡∏Å‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏à‡∏≤‡∏Å JSON object
        3.  **‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå:** ‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏Å‡∏£‡∏ì‡∏µ‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
        4.  **‡∏™‡∏£‡πâ‡∏≤‡∏á 3 ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å:** ‡∏¢‡∏Å‡∏£‡πà‡∏≤‡∏á "‡∏Ç‡πâ‡∏≠ ‡πë" ‡∏°‡∏≤ {num_options} ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö ‡πÇ‡∏î‡∏¢‡∏≠‡∏≤‡∏à‡∏î‡∏±‡∏î‡πÅ‡∏õ‡∏•‡∏á‡∏ñ‡πâ‡∏≠‡∏¢‡∏Ñ‡∏≥‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏¢‡∏∂‡∏î‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡∏≠‡∏á‡∏Å‡∏£‡∏ì‡∏µ‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ
        5.  **‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå:** ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô JSON Array ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏ï‡∏£‡∏¥‡∏á {num_options} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡∏´‡πâ‡∏≤‡∏°‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏∑‡πà‡∏ô‡πÉ‡∏î‡∏ô‡∏≠‡∏Å‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏à‡∏≤‡∏Å JSON Array
        6.  **‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á:** ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏™‡∏ï‡∏£‡∏¥‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ "‡πë. " ‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏©‡∏≤‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏™‡∏•‡∏∞‡∏™‡∏•‡∏ß‡∏¢
        """

    # --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 3: User Prompt ---
    user_prompt = f"""
        <ReferenceData>
            <sender_department>{sender_department}</sender_department>
            <document_number>{doc_number}</document_number>
            <document_date>{doc_date}</document_date>
            <subject>{doc_subject}</subject>
            <main_intent>{main_intent}</main_intent>
            <requested_details>{requested_details}</requested_details>
        </ReferenceData>

        <FullContent>
            {ocr_text_content}
        </FullContent>

        <Instructions>
            <Task>‡πÇ‡∏õ‡∏£‡∏î‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏°‡∏≤ ‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏Å‡∏£‡∏ì‡∏µ‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î ‡πÅ‡∏•‡πâ‡∏ß‡∏¢‡∏Å‡∏£‡πà‡∏≤‡∏á "‡∏Ç‡πâ‡∏≠ ‡πë" ‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤ **{num_options} ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö** </Task>
            <OutputFormat>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÄ‡∏õ‡πá‡∏ô JSON Object ‡∏ó‡∏µ‡πà‡∏°‡∏µ key `style_1`, `style_2`, ‡πÅ‡∏•‡∏∞ `style_3` ‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏ô System Prompt ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏Ñ‡∏£‡πà‡∏á‡∏Ñ‡∏£‡∏±‡∏î</OutputFormat>
        </Instructions>
        """

    try:
        response = client.chat(
            model=LLM_MODEL,
            messages=[
                {'role': 'system', 'content': system_prompt},
                {'role': 'user', 'content': user_prompt}
            ],
            format="json",
            options={
                'temperature': 0.6,
                'num_predict': 2048,
                'top_p': 0.9,
                'repetition_penalty': 1.1
            }
        )
        content_str = response['message']['content'].strip()
        print(f"DEBUG [replySec1_generation] Raw LLM response:\n---\n{content_str}\n---")

        # --- ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£ Parse ---
        try:
            data = json.loads(content_str)
            if isinstance(data, list) and all(isinstance(item, str) for item in data):
                options = [opt.strip() for opt in data if opt.strip()][:num_options]
                if options:
                    print("SUCCESS: Parsed as JSON list.")
                    return options
            elif isinstance(data, dict):
                options = [str(v).strip() for v in data.values() if str(v).strip()][:num_options]
                if options:
                    print("SUCCESS: Parsed as JSON dictionary, extracted values.")
                    return options
        except json.JSONDecodeError:
            print("INFO: Response is not a valid JSON. Trying fallback methods.")

        # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ "‡πë. " ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠)
        if content_str.count("‡πë.") > 1:
            parts = [part.strip() for part in content_str.split("‡πë.") if part.strip()]
            options = [f"‡πë. {part}" for part in parts][:num_options]
            if options:
                print("SUCCESS: Fallback - Split by '‡πë.'")
                return options

        # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏±‡∏ô‡πÄ‡∏õ‡πá‡∏ô List ‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏™‡∏ï‡∏£‡∏¥‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà ‡πÄ‡∏ä‡πà‡∏ô "['‡∏Ç‡πâ‡∏≠1', '‡∏Ç‡πâ‡∏≠2']"
        if content_str.startswith('[') and content_str.endswith(']'):
            try:
                evaluated_data = ast.literal_eval(content_str)
                if isinstance(evaluated_data, list):
                    options = [str(item).strip() for item in evaluated_data if str(item).strip()][:num_options]
                    if options:
                        print("SUCCESS: Fallback - Parsed string as a literal list.")
                        return options
            except (ValueError, SyntaxError):
                pass 

        print("WARN: All parsing methods failed. Returning empty list.")
        return []

    except Exception as e:
        print(f"ERROR [replySec1_generation]: Exception during LLM call or processing: {e}")
        return []
        


def _build_prompts_for_intent(reply_intent: str, extracted_info: dict, relevant_internal_data: dict) -> tuple[str, str]:
    
    our_department_name = (relevant_internal_data or {}).get("our_department_name", "[‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô]")
    user_provided_opening = extracted_info.pop("user_provided_opening_paragraph", "")

    # --- System Prompt ---
    system_prompt_base = f"""‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ "‡πÄ‡∏™‡∏°‡∏µ‡∏¢‡∏ô‡πÄ‡∏≠‡∏Å‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞" ‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏Å‡∏≤‡∏£‡∏£‡πà‡∏≤‡∏á‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÑ‡∏ó‡∏¢ ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö ‡πÅ‡∏•‡πâ‡∏ß‡∏¢‡∏Å‡∏£‡πà‡∏≤‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (‡∏Ç‡πâ‡∏≠ ‡πí, ‡πì, ...) ‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å "‡∏Ç‡πâ‡∏≠ ‡πë" ‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏°‡∏≤‡πÉ‡∏´‡πâ‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå

<‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏£‡πà‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•>
1.  **‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:** ‡∏à‡∏á‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å "‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ï‡πâ‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á" ‡πÅ‡∏•‡∏∞ "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö" ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
2.  **‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô:** ‡∏ï‡πâ‡∏≠‡∏á‡∏ô‡∏≥‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å "‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ï‡πâ‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á" (‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á, ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà, ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà, ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°, ‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•) ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡πà‡∏≤‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡πÅ‡∏•‡∏∞‡∏™‡∏°‡πÄ‡∏´‡∏ï‡∏∏‡∏™‡∏°‡∏ú‡∏•
3.  **‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏£‡∏Ñ‡πå‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏°‡∏∑‡∏≠‡∏≠‡∏≤‡∏ä‡∏µ‡∏û:** ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ñ‡πâ‡∏≠‡∏¢‡∏Ñ‡∏≥‡πÅ‡∏•‡∏∞‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏° ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå ‡∏™‡∏•‡∏∞‡∏™‡∏•‡∏ß‡∏¢ ‡πÅ‡∏•‡∏∞‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏á‡πà‡∏≤‡∏¢‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡πå‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô ‡πÅ‡∏ï‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡∏´‡πâ‡∏≤‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡πÄ‡∏≠‡∏á
4.  **‡∏¢‡∏∂‡∏î‡∏ï‡∏≤‡∏°‡πÄ‡∏à‡∏ï‡∏ô‡∏≤:** ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏£‡πà‡∏≤‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö "‡πÄ‡∏à‡∏ï‡∏ô‡∏≤‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö" ‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÑ‡∏ß‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡∏ï‡∏≤‡∏° <‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏£‡πà‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏à‡∏ï‡∏ô‡∏≤>

<‡∏Å‡∏é‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î)>
- ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ "‡∏Ç‡πâ‡∏≠ ‡πë" ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏°‡∏≤‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ï‡πà‡∏≠‡∏Ñ‡∏≥ ‡∏´‡πâ‡∏≤‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏£‡∏∑‡∏≠‡∏î‡∏±‡∏î‡πÅ‡∏õ‡∏•‡∏á
- ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤ (Plain Text) ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡∏´‡πâ‡∏≤‡∏°‡∏°‡∏µ Tag ‡∏´‡∏£‡∏∑‡∏≠ Placeholder
- **‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏Ç‡πâ‡∏≠‡πÅ‡∏ö‡∏ö‡πÑ‡∏ó‡∏¢‡πÅ‡∏•‡∏∞‡∏à‡∏∏‡∏î (‡πÄ‡∏ä‡πà‡∏ô ‡πí., ‡πì., ‡πî.) ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡∏´‡πâ‡∏≤‡∏°‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏Ç‡πâ‡∏≠" ‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏î‡∏¢‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î**
- ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏°‡∏≤‡∏Å‡∏™‡∏∏‡∏î‡πÑ‡∏î‡πâ‡πÅ‡∏Ñ‡πà 4 ‡∏Ç‡πâ‡∏≠‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏Å‡∏¥‡∏ô
- ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡∏≥‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏Å‡∏±‡∏ö‡πÄ‡∏à‡∏ï‡∏ô‡∏≤ (‡πÄ‡∏ä‡πà‡∏ô ‡∏à‡∏∂‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏°‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏õ‡∏£‡∏î‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤, ‡∏à‡∏∂‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏°‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏õ‡∏£‡∏î‡∏ó‡∏£‡∏≤‡∏ö)
"""

    user_prompt_parts = []
    system_prompt_addendum = "" 

    if reply_intent == "‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥/‡πÄ‡∏´‡πá‡∏ô‡∏ä‡∏≠‡∏ö":
        system_prompt_addendum = """
<‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏£‡πà‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏à‡∏ï‡∏ô‡∏≤ "‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥/‡πÄ‡∏´‡πá‡∏ô‡∏ä‡∏≠‡∏ö">
- **‡πí.** ‡πÉ‡∏´‡πâ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏ß‡πà‡∏≤‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤ ({our_department_name}) ‡πÑ‡∏î‡πâ‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏ô‡∏≠‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏•‡∏∞‡πÄ‡∏´‡πá‡∏ô‡∏ß‡πà‡∏≤‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á
- **‡πì.** ‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏∏ "‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠" ‡πÇ‡∏î‡∏¢‡πÄ‡∏™‡∏ô‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠ "‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥/‡πÄ‡∏´‡πá‡∏ô‡∏ä‡∏≠‡∏ö" ‡πÉ‡∏ô‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≠‡∏á‡∏Ç‡∏≠ ‡πÅ‡∏•‡∏∞‡∏≠‡∏≤‡∏à‡∏ï‡∏≤‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏ô‡∏≠‡πÉ‡∏´‡πâ "‡∏°‡∏µ‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÅ‡∏à‡πâ‡∏á..." ‡∏´‡∏£‡∏∑‡∏≠ "‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏á‡∏≤‡∏ô..." ‡∏ï‡πà‡∏≠‡πÑ‡∏õ
</‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏£‡πà‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏à‡∏ï‡∏ô‡∏≤>
"""
    elif reply_intent == "‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò/‡πÑ‡∏°‡πà‡πÄ‡∏´‡πá‡∏ô‡∏ä‡∏≠‡∏ö":
        system_prompt_addendum = """
<‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏£‡πà‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏à‡∏ï‡∏ô‡∏≤ "‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò/‡πÑ‡∏°‡πà‡πÄ‡∏´‡πá‡∏ô‡∏ä‡∏≠‡∏ö">
- **‡πí.** ‡πÉ‡∏´‡πâ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏†‡∏≤‡∏û (‡πÄ‡∏ä‡πà‡∏ô ‡∏ï‡∏¥‡∏î‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô, ‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠) ‡πÅ‡∏•‡∏∞‡∏≠‡∏≤‡∏à‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏ß‡πà‡∏≤‡πÑ‡∏î‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏á‡∏≤‡∏ô‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß
- **‡πì.** ‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏∏ "‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠" ‡πÇ‡∏î‡∏¢‡πÄ‡∏™‡∏ô‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠ "‡∏°‡∏µ‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ï‡πâ‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏£‡∏≤‡∏ö"
</‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏£‡πà‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏à‡∏ï‡∏ô‡∏≤>
"""
    elif reply_intent == "‡∏ï‡∏≠‡∏ö‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö":
        system_prompt_addendum = """
<‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏£‡πà‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏à‡∏ï‡∏ô‡∏≤ "‡∏ï‡∏≠‡∏ö‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö">
- **‡πí.** ‡πÉ‡∏´‡πâ‡πÅ‡∏à‡πâ‡∏á‡∏ß‡πà‡∏≤‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤ ({our_department_name}) ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÑ‡∏ß‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß
- **‡πì.** ‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏∏‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡πÑ‡∏õ ‡πÄ‡∏ä‡πà‡∏ô "‡∏à‡∏∞‡∏ô‡∏≥‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏™‡∏±‡πà‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡πÑ‡∏õ" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏à‡∏∞‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏•‡πÉ‡∏´‡πâ‡∏ó‡∏£‡∏≤‡∏ö‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á" ‡πÅ‡∏•‡∏∞‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢ "‡∏à‡∏∂‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏°‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏õ‡∏£‡∏î‡∏ó‡∏£‡∏≤‡∏ö"
</‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏£‡πà‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏à‡∏ï‡∏ô‡∏≤>
"""
    elif reply_intent == "‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á/‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏á‡∏≤‡∏ô":
        system_prompt_addendum = """
<‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏£‡πà‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏à‡∏ï‡∏ô‡∏≤ "‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á/‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏á‡∏≤‡∏ô">
- **‡πí.** ‡πÉ‡∏´‡πâ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏ß‡πà‡∏≤‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤ ({our_department_name}) ‡πÑ‡∏î‡πâ‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏•‡∏∞‡πÄ‡∏´‡πá‡∏ô‡∏Ñ‡∏ß‡∏£‡∏™‡πà‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ï‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
- **‡πì.** ‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏∏ "‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠" ‡πÇ‡∏î‡∏¢‡πÄ‡∏™‡∏ô‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠ "‡∏™‡πà‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏´‡πâ [‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á] ‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏õ" ‡πÅ‡∏•‡∏∞‡∏≠‡∏≤‡∏à‡πÄ‡∏™‡∏ô‡∏≠‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ï‡πâ‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏£‡∏≤‡∏ö‡∏î‡πâ‡∏ß‡∏¢
</‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏£‡πà‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏à‡∏ï‡∏ô‡∏≤>
"""
    else: 
        return (None, "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏û‡∏ö Template ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏à‡∏ï‡∏ô‡∏≤‡∏ô‡∏µ‡πâ")

    # User Prompt 
    original_doc_context_parts = ["--- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ï‡πâ‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á) ---"]
    for key, value in extracted_info.items():
        if value and isinstance(value, (str, list)): 
            original_doc_context_parts.append(f"- {key}: {value}")
    original_doc_context = "\n".join(original_doc_context_parts)

    user_prompt = f"""
{original_doc_context}

---
‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö:
- ‡∏Ç‡πâ‡∏≠ ‡πë ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô: {user_provided_opening}
- ‡πÄ‡∏à‡∏ï‡∏ô‡∏≤‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö: {reply_intent}
- ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤ (‡∏ú‡∏π‡πâ‡∏ï‡∏≠‡∏ö): {our_department_name}

---
‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á:
‡∏à‡∏á‡∏ó‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏°‡∏µ‡∏¢‡∏ô‡πÄ‡∏≠‡∏Å‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞ ‡∏£‡πà‡∏≤‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏à‡∏≤‡∏Å ‡πí.) ‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å "‡∏Ç‡πâ‡∏≠ ‡πë" ‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏°‡∏≤‡πÉ‡∏´‡πâ‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏°‡∏≤‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤ ‡πÅ‡∏•‡∏∞‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏° <‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏£‡πà‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏à‡∏ï‡∏ô‡∏≤> ‡πÅ‡∏•‡∏∞ <‡∏Å‡∏é‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•> ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏Ñ‡∏£‡πà‡∏á‡∏Ñ‡∏£‡∏±‡∏î
"""

    final_system_prompt = system_prompt_base + system_prompt_addendum
    return final_system_prompt, user_prompt



def replySec234_generation(client, extracted_info: dict, original_doc_type: str, reply_intent: str, relevant_internal_data: dict = None):
    if not OLLAMA_AVAILABLE[1]:
        return "‡∏£‡∏∞‡∏ö‡∏ö AI (Ollama) ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠"

    if not extracted_info:
        return "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏™‡∏Å‡∏±‡∏î‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö"

    if not extracted_info.get("user_provided_opening_paragraph", "").strip():
        return "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö '‡∏Ç‡πâ‡∏≠ ‡πë' ‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡πà‡∏≤‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ï‡πà‡∏≠"

    system_prompt, user_prompt = _build_prompts_for_intent(reply_intent, extracted_info, relevant_internal_data)

    if not system_prompt:
        return user_prompt

    try:
        response = client.chat(
            model= LLM_MODEL,
            messages=[
                {'role': 'system', 'content': system_prompt},
                {'role': 'user', 'content': user_prompt}
            ],
            options={
                'temperature': 0.1,
                'num_predict': 2048,
                'top_p': 0.7,
                'repetition_penalty': 1.1
            }
        )
        raw_response = response['message']['content'].strip()
        
        if raw_response.startswith("```") and raw_response.endswith("```"):
            cleaned_response = '\n'.join(raw_response.split('\n')[1:-1]).strip()
        else:
            cleaned_response = raw_response

        cleaned_response = re.sub(r'<\s*[/]?[^>]+>', '', cleaned_response)
        our_department_name = (relevant_internal_data or {}).get("our_department_name", "")
        cleaned_response = cleaned_response.replace('{{our_department_name}}', our_department_name)
        cleaned_response = '\n'.join([line.strip() for line in cleaned_response.splitlines() if line.strip()])
            
        return cleaned_response
        
    except Exception as e:
        print(f"ERROR [replySec234_generation]: Exception - {e}")
        return f"‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ AI ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö: {e}"

# Page 3 : Chat bot  

SYSTEM_USAGE_KNOWLEDGE = """
    # ‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞

    ## ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö
    ‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡∏°‡∏µ 3 ‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å:
    1.  **‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å:** ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö
    2.  **‡∏£‡πà‡∏≤‡∏á‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£:** ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏†‡∏≤‡∏©‡∏≤‡∏û‡∏π‡∏î
    3.  **‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö:** ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏£‡∏±‡∏ö (PDF) ‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡πà‡∏≤‡∏á‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö

    ## ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏ô‡∏π "‡∏£‡πà‡∏≤‡∏á‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£" (‚úçÔ∏è)
    1.  **‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1: ‡πÉ‡∏™‡πà‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£:** ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏∞‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡∏î‡πâ‡∏ß‡∏¢‡∏†‡∏≤‡∏©‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡∏ç‡πà
    2.  **‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤:**
        - ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£" ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£: "‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏Ç‡πà‡∏≤‡∏ß‡∏£‡πà‡∏ß‡∏° (‡∏ó‡∏ó.)" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°"
        - ‡∏´‡∏≤‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°" ‡∏à‡∏∞‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏Ñ‡∏≥‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô" (‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡πÄ‡∏™‡∏ô‡∏≠) ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏î‡πâ‡∏ß‡∏¢
        - ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£" ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
    3.  **‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‚ú® ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£":** AI ‡∏à‡∏∞‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á
    4.  **‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå:** ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏î‡πâ

    ## ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏ô‡∏π "‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏ó‡∏≥‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö" (üì¨)
    ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î:
    1.  **‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå:** ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå PDF ‡∏Ç‡∏≠‡∏á "‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏£‡∏±‡∏ö" ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏∞‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö
    2.  **‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1.1: ‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£:** ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏õ‡πá‡∏ô "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏Ç‡πà‡∏≤‡∏ß‡∏£‡πà‡∏ß‡∏° (‡∏ó‡∏ó.)"
    3.  **‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1.2: ‡∏™‡∏Å‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:** ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "üìä ‡∏™‡∏Å‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ AI ‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏à‡∏≤‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏°‡∏≤
    4.  **‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1.3: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:** ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏™‡∏Å‡∏±‡∏î‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏° ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î "üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"
    5.  **‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2.1: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô '‡∏Ç‡πâ‡∏≠ ‡πë':**
        - ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‚ú® ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å '‡∏Ç‡πâ‡∏≠ ‡πë'..." ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ AI ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö
        - ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å Radio button ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô Text Area ‡πÉ‡∏´‡πâ‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î "üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô '‡∏Ç‡πâ‡∏≠ ‡πë' ‡∏ô‡∏µ‡πâ"
    6.  **‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2.2: ‡πÉ‡∏´‡πâ AI ‡∏ä‡πà‡∏ß‡∏¢‡∏£‡πà‡∏≤‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠:**
        - ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏ï‡∏≠‡∏ö" ‡πÅ‡∏•‡∏∞ "‡πÄ‡∏à‡∏ï‡∏ô‡∏≤‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö" (‡πÄ‡∏ä‡πà‡∏ô ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥, ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò, ‡∏ï‡∏≠‡∏ö‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö, ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á)
        - ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "ü§ñ ‡πÉ‡∏´‡πâ AI ‡∏ä‡πà‡∏ß‡∏¢‡∏£‡πà‡∏≤‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ï‡πà‡∏≠ (‡∏Ç‡πâ‡∏≠ ‡πí, ‡πì, ...)"
    7.  **‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 3: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏ô‡∏≥‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô:**
        - ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏£‡πà‡∏≤‡∏á‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏â‡∏ö‡∏±‡∏ö‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢
        - ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå .docx ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ
    """

@st.cache_data(ttl=3600)
def load_and_chunk_kbase(pdf_path: str, chunk_size_lines: int = 10) -> list[str]:
    try:
        if not os.path.exists(pdf_path):
            return ["‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡∏á‡∏≤‡∏ô‡∏™‡∏≤‡∏£‡∏ö‡∏£‡∏£‡∏ì"]
        
        doc = fitz.open(pdf_path)
        full_text = ""
        for page in doc:
            full_text += page.get_text("text")
        doc.close()
        
        # Clean up text
        lines = [line.strip() for line in full_text.split('\n') if line.strip()]
        
        # Chunking
        chunks = []
        for i in range(0, len(lines), chunk_size_lines):
            chunk = " ".join(lines[i:i + chunk_size_lines])
            chunks.append(re.sub(r'\s+', ' ', chunk).strip())
            
        return chunks
    except Exception as e:
        print(f"Error loading and chunking PDF knowledge: {e}")
        return [f"‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå PDF: {e}"]

#--- Vector Embeddings for Knowledge Base ---
@st.cache_resource
def load_embedding_model():
    print("Loading embedding model...")
    return SentenceTransformer('intfloat/multilingual-e5-large')

embedding_model = load_embedding_model()

# ‡∏™‡∏£‡πâ‡∏≤‡∏á KB ‡πÅ‡∏•‡∏∞ Embeddings ‡πÅ‡∏¢‡∏Å‡∏Å‡∏±‡∏ô
KB_PATH = "k_base/02-sarabun_2566.pdf" 
Kbase_chunks = load_and_chunk_kbase(KB_PATH)
usage_chunks = [chunk for chunk in SYSTEM_USAGE_KNOWLEDGE.split('\n\n') if chunk.strip()]

@st.cache_data(show_spinner=False)
def embed_chunks(chunks_to_embed):
    print(f"Embedding {len(chunks_to_embed)} chunks...")
    return embedding_model.encode(chunks_to_embed)

Kbase_embeddings = embed_chunks(Kbase_chunks)
usage_embeddings = embed_chunks(usage_chunks)


# --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Router ---
def search_in_kb(query: str, chunks: list, embeddings: np.ndarray, n_results: int = 3) -> str:
    
    query_embedding = embedding_model.encode(query)
    cos_similarities = np.dot(embeddings, query_embedding) / (norm(embeddings, axis=1) * norm(query_embedding))
    top_indices = np.argsort(cos_similarities)[::-1][:n_results]
    top_chunks = [chunks[i] for i in top_indices]
    return "\n---\n".join(top_chunks) if top_chunks else "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á"

def query_router(client, query: str) -> str:
    
    router_prompt = f"""‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ AI ‡∏Ñ‡∏±‡∏î‡πÅ‡∏¢‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏´‡∏ô‡∏∂‡πà‡∏á‡πÉ‡∏ô‡∏™‡∏≤‡∏°‡∏Ñ‡∏≥‡∏ô‡∏µ‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô: "‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö", "‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡∏™‡∏≤‡∏£‡∏ö‡∏£‡∏£‡∏ì", ‡∏´‡∏£‡∏∑‡∏≠ "‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ"

- ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°, ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö, ‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏£‡∏∞‡∏ö‡∏ö" ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° ‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ö‡∏ß‡πà‡∏≤: ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
- ‡∏ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏≠‡πâ‡∏≤‡∏á‡∏ñ‡∏∂‡∏á‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡∏á‡∏≤‡∏ô‡∏™‡∏≤‡∏£‡∏ö‡∏£‡∏£‡∏ì" ‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ö‡∏ß‡πà‡∏≤: ‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡∏™‡∏≤‡∏£‡∏ö‡∏£‡∏£‡∏ì
- ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢, ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì, ‡∏´‡∏£‡∏∑‡∏≠‡∏ô‡∏≠‡∏Å‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏à‡∏≤‡∏Å‡∏™‡∏≠‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≤‡∏á‡∏ö‡∏ô ‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ö‡∏ß‡πà‡∏≤: ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ

‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: "{query}"
‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ñ‡∏∑‡∏≠:"""

    try:
        response = client.chat(
            model = LLM_MODEL,
            messages=[{'role': 'user', 'content': router_prompt}],
            options={'temperature': 0, 'num_predict': 50}
        )
        return response['message']['content'].strip()
    except Exception:
        return "‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö"

    
# --- call_chatbot ---
def call_chatbot(history: list):
    if not OLLAMA_AVAILABLE:
        return "‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡∏£‡∏∞‡∏ö‡∏ö AI ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ"

    user_query = ""
    for msg in reversed(history):
        if msg['role'] == 'user':
            user_query = msg['content']
            break
            
    if not user_query:
        return "‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡∏ú‡∏°‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á"

    # Step 1: ‡πÉ‡∏ä‡πâ Router ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏´‡∏ô
    with st.spinner("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°..."):
        route = query_router(ollama_client, user_query)
        st.write(f"‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°: {route}")

    # Step 2: ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô Knowledge Base ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
    relevant_context = ""
    if "‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö" in route:
        with st.spinner("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö..."):
            relevant_context = search_in_kb(user_query, usage_chunks, usage_embeddings)
    elif "‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡∏™‡∏≤‡∏£‡∏ö‡∏£‡∏£‡∏ì" in route:
        with st.spinner("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡∏™‡∏≤‡∏£‡∏ö‡∏£‡∏£‡∏ì..."):
            relevant_context = search_in_kb(user_query, Kbase_chunks, Kbase_embeddings)
    else: 
        relevant_context = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á"
    
    # Step 3: ‡∏™‡∏£‡πâ‡∏≤‡∏á Prompt ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö 
    system_prompt = f"""‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ "‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞" ‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏Ç‡∏≠‡∏á "‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥"
    ‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÇ‡∏î‡∏¢‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å **"‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á"** ‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å
    
    - **‡∏ï‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°:** ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏°‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô ‡∏ñ‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô ‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠ ‡πÜ ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
    - **‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:** ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏°‡∏≤ ‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ö‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à
    - **‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ:** ‡∏´‡∏≤‡∏Å "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á" ‡∏ï‡∏≠‡∏ö‡∏ß‡πà‡∏≤ "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á" ‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ö‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏†‡∏≤‡∏û‡∏ß‡πà‡∏≤ "‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡∏ú‡∏°‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á '{user_query}' ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ú‡∏°" **‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏î‡∏≤‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î**
    - **‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏¥‡∏ï‡∏£‡πÅ‡∏•‡∏∞‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠:** ‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏©‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏á‡πà‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏¥‡∏ï‡∏£
    """
    
    user_prompt_with_context = f"""
    --- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á ---
    {relevant_context}
    ---
    ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: "{user_query}"
    ---
    ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á: ‡πÇ‡∏õ‡∏£‡∏î‡πÉ‡∏ä‡πâ "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á" ‡∏Ç‡πâ‡∏≤‡∏á‡∏ï‡πâ‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏≠‡∏ö "‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ"
    """
    try:
        response = ollama_client.chat(
            model=LLM_MODEL,
            messages=[
                {'role': 'system', 'content': system_prompt},
                {'role': 'user', 'content': user_prompt_with_context}
            ],
            options = {
                'temperature': 0.3, 
                'top_p': 0.9,   
                'num_predict': 4096
            }
        )
        return response['message']['content']
    except Exception as e:
        print(f"Error during chatbot call: {e}")
        return f"‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö AI: {e}"
